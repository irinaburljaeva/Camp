<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–®–ê–ì–ê–ô –î–û–ú–ê: –ó–∏–º–Ω—è—è –∏–≥—Ä–∞</title>

  <style>
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#a8c0ff 0%,#3f2b96 100%);
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      min-height:100vh; margin:0; color:#fff;
      user-select:none;
    }

    h1{ text-shadow:2px 2px 4px rgba(0,0,0,.3); margin:0 0 10px; text-align:center; }

    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:center;
      flex-wrap:wrap;
      margin-bottom:14px;
    }

    .pill{
      background:rgba(255,255,255,.2);
      padding:10px 16px;
      border-radius:15px;
      font-size:18px;
      box-shadow:0 4px 6px rgba(0,0,0,.1);
      display:flex; gap:8px; align-items:center;
    }

    .grid{
      display:flex; flex-wrap:wrap;
      width:560px; height:560px;
      background:rgba(255,255,255,.3);
      border-radius:10px;
      padding:5px;
      box-shadow:0 10px 20px rgba(0,0,0,.2);
      position:relative;
    }

    .cell{
      width:70px; height:70px;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      transition:transform .18s, filter .18s, background-color .18s;
      border-radius:18px;

      background-repeat:no-repeat;
      background-position:center;
      background-size:contain;
      position:relative;
      overflow:hidden;
    }

    .cell:hover{
      transform:scale(1.06);
      background-color:rgba(255,255,255,.08);
    }

    .selected{
      background-color:rgba(255,255,255,.28) !important;
      transform:scale(1.10) !important;
      outline:2px solid rgba(255,255,255,.45);
      outline-offset:-2px;
    }

    .fade-out{ animation:fadeOut .45s forwards; }
    @keyframes fadeOut{ to{opacity:0; transform:scale(0)} }

    /* ---- –≤–∏–∑—É–∞–ª —Å–ø–µ—Ü–æ–≤ ---- */
    .cell[data-type="special_line"]{ filter:drop-shadow(0 0 10px rgba(255,215,0,.55)); }
    .cell[data-type="special_bomb"]{ filter:drop-shadow(0 0 10px rgba(255,255,255,.35)); }
    .cell[data-type="special_clear"]{ filter:drop-shadow(0 0 12px rgba(255,215,0,.75)); }
    .cell[data-type="special_candle"]{ filter:drop-shadow(0 0 12px rgba(255,140,0,.65)); }

    /* ---- –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è ---- */
    /* —Å—É–≥—Ä–æ–±: –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è ‚Äú—à–∞–ø–∫–∞‚Äù + –∑–∞–º–æ–∫ */
    .cell[data-block="snow"]::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.7), rgba(255,255,255,0) 55%),
        radial-gradient(circle at 70% 40%, rgba(255,255,255,.6), rgba(255,255,255,0) 60%),
        linear-gradient(to bottom, rgba(255,255,255,.55), rgba(255,255,255,.15));
      opacity:.95;
      pointer-events:none;
    }
    .cell[data-block="snow"]::before{
      content:"‚õî";
      position:absolute; right:6px; top:6px;
      font-size:16px; opacity:.9;
      pointer-events:none;
    }

    /* –ª—ë–¥: —Å–∏–Ω–µ–≤–∞—Ç–∞—è –ø–ª—ë–Ω–∫–∞ + —Ü–∏—Ñ—Ä–∞ –ø—Ä–æ—á–Ω–æ—Å—Ç–∏ */
    .cell[data-block="ice"]::after{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(135deg, rgba(160,220,255,.55), rgba(70,160,255,.25)),
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,0) 55%);
      opacity:.95;
      pointer-events:none;
    }
    .cell[data-block="ice"]::before{
      content:attr(data-ice);
      position:absolute; right:8px; top:6px;
      font-weight:700;
      font-size:14px;
      background:rgba(0,0,0,.25);
      padding:2px 6px;
      border-radius:10px;
      pointer-events:none;
    }

    /* ---- –º–æ–¥–∞–ª–∫–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π —É—Ä–æ–≤–Ω—è ---- */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:50;
    }
    .overlay.show{ display:flex; }

    .modal{
      width:min(560px, 95vw);
      background:rgba(255,255,255,.96);
      color:#1f2937;
      border-radius:18px;
      padding:18px 18px 14px;
      box-shadow:0 16px 48px rgba(0,0,0,.35);
    }
    .modal h2{ margin:0 0 8px; font-size:20px; }
    .modal p{ margin:0 0 10px; line-height:1.45; }
    .modal ul{ margin:0 0 12px; padding-left:18px; }
    .modal li{ margin:6px 0; }
    .modal .actions{ display:flex; gap:10px; margin-top:10px; }
    .modal button{
      flex:1;
      margin:0;
      padding:10px 14px;
      font-size:16px;
      background:#ff6b6b;
      color:#fff;
      border:none;
      border-radius:14px;
      cursor:pointer;
      box-shadow:0 6px 18px rgba(0,0,0,.18);
      transition:background .2s, transform .15s;
    }
    .modal button:hover{ background:#ff4757; transform:translateY(-1px); }

    /* ---- –∫–Ω–æ–ø–∫–∏ —Å–Ω–∏–∑—É ---- */
    .btnbar{ display:flex; gap:12px; margin-top:18px; flex-wrap:wrap; justify-content:center; }
    .btnbar button{
      padding:10px 20px;
      font-size:18px;
      background:#ff6b6b;
      color:#fff;
      border:none;
      border-radius:50px;
      cursor:pointer;
      box-shadow:0 4px 15px rgba(0,0,0,.2);
      transition:background .3s, transform .15s;
    }
    .btnbar button:hover{ background:#ff4757; transform:translateY(-1px); }

    @media (max-width: 600px){
      .grid{ width:350px; height:350px; }
      .cell{ width:43.75px; height:43.75px; border-radius:14px; }
      h1{ font-size:24px; }
      .pill{ font-size:16px; }
    }
  </style>
</head>

<body>
  <h1>‚ùÑÔ∏è –®–ê–ì–ê–ô –î–û–ú–ê: –ó–∏–º–Ω—è—è –∏–≥—Ä–∞ ‚ùÑÔ∏è</h1>

  <div class="topbar">
    <div class="pill">–£—Ä–æ–≤–µ–Ω—å: <b id="level">1</b></div>
    <div class="pill">–û—á–∫–∏: <b id="score">0</b></div>
    <div class="pill">–¶–µ–ª—å: <b id="target">0</b></div>
  </div>

  <div class="grid" id="grid"></div>

  <div class="btnbar">
    <button onclick="startGame()">üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
    <button onclick="showIntro()">üìú –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —É—Ä–æ–≤–Ω—è</button>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal">
      <h2 id="introTitle">–£—Ä–æ–≤–µ–Ω—å</h2>
      <p id="introText"></p>
      <ul id="introList"></ul>
      <div class="actions">
        <button id="introBtn">–ü–æ–Ω—è—Ç–Ω–æ, –∏–≥—Ä–∞—é!</button>
      </div>
    </div>
  </div>

<script>
/* =========================================================================
   –ù–ê–°–¢–†–û–ô–ö–ê –ü–£–¢–ï–ô –ö –ö–ê–†–¢–ò–ù–ö–ê–ú
   -------------------------------------------------------------------------
   –í–ê–ñ–ù–û:
   - –ï—Å–ª–∏ —ç—Ç–æ—Ç HTML –ª–µ–∂–∏—Ç –í –¢–û–ô –ñ–ï –ø–∞–ø–∫–µ, —á—Ç–æ –∏ IMG_3655.png –∏ —Ç.–¥. ‚Äî –æ—Å—Ç–∞–≤—å ''.
   - –ï—Å–ª–∏ HTML –ª–µ–∂–∏—Ç –≤—ã—à–µ, –∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤ –ø–∞–ø–∫–µ /wintergame/ ‚Äî –ø–æ—Å—Ç–∞–≤—å 'wintergame/'.
============================================================================ */
const ASSET_PATH = ''; // –Ω–∞–ø—Ä–∏–º–µ—Ä: 'wintergame/'

const IMG = {
  // –æ–±—ã—á–Ω—ã–µ
  snowflake: ASSET_PATH + 'IMG_3660.png',
  thermos:   ASSET_PATH + 'IMG_3661.png',
  steps:     ASSET_PATH + 'IMG_3662.png',
  boots:     ASSET_PATH + 'IMG_3663.png',
  mittens:   ASSET_PATH + 'IMG_3664.png',
  tree:      ASSET_PATH + 'IMG_3659.png',

  // —Å–ø–µ—Ü
  goldSteps:    ASSET_PATH + 'IMG_3655.png', // –æ—á–∏—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É
  candle:       ASSET_PATH + 'IMG_3656.png', // —Ä–∞–∑–º–æ—Ä–∞–∂–∏–≤–∞–µ—Ç –ª—ë–¥
  giftBag:      ASSET_PATH + 'IMG_3657.png', // –≤–∑—Ä—ã–≤ —Ä–∞–¥–∏—É—Å–æ–º
  goldSnowflake:ASSET_PATH + 'IMG_3658.png', // –æ—á–∏—â–∞–µ—Ç —ç–∫—Ä–∞–Ω
};

const NORMAL_COLORS = ['snowflake','thermos','steps','boots','mittens','tree'];

// —Ç–∏–ø—ã —Å–ø–µ—Ü–æ–≤
const SPECIAL = {
  LINE:  'special_line',
  BOMB:  'special_bomb',
  CLEAR: 'special_clear',
  CANDLE:'special_candle',
};

// –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
const BLOCK = {
  SNOW: 'snow',
  ICE:  'ice',
};

// —É—Ä–æ–≤–Ω–∏ –ø–æ —Ç–≤–æ–µ–º—É –¢–ó
const LEVELS = [
  { id:1,  target: 60,  intro:"–£—Ä–æ–≤–µ–Ω—å 1 ‚Äî –±–µ–∑ —Å–ø–µ—Ü-—ç–ª–µ–º–µ–Ω—Ç–æ–≤. –ü—Ä–æ—Å—Ç–æ —Å–æ–±–∏—Ä–∞–π—Ç–µ 3 –≤ —Ä—è–¥.", specials:[], obstacles:[] },
  { id:2,  target: 80,  intro:"–£—Ä–æ–≤–µ–Ω—å 2 ‚Äî –ø–æ—è–≤–ª—è—é—Ç—Å—è ¬´–ó–æ–ª–æ—Ç—ã–µ —à–∞–≥–∏¬ª. –°–æ–±–µ—Ä–∏—Ç–µ 4 –≤ —Ä—è–¥ ‚Üí –ø–æ—è–≤–∏—Ç—Å—è —Å–ø–µ—Ü. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –µ–≥–æ —Å–ª–µ–¥—É—é—â–∏–º —Ö–æ–¥–æ–º (–ø–µ—Ä–µ–¥–≤–∏–Ω—å—Ç–µ) ‚Üí –æ—á–∏—Å—Ç–∏—Ç—Å—è —Å—Ç—Ä–æ–∫–∞.", specials:[SPECIAL.LINE], obstacles:[] },
  { id:3,  target: 95,  intro:"–£—Ä–æ–≤–µ–Ω—å 3 ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –º–µ—à–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤. –°–æ–±–µ—Ä–∏—Ç–µ L/T-–∫–æ–º–±–∏–Ω–∞—Ü–∏—é ‚Üí –ø–æ—è–≤–∏—Ç—Å—è –º–µ—à–æ–∫, –æ–Ω –≤–∑—Ä—ã–≤–∞–µ—Ç –æ–±–ª–∞—Å—Ç—å 3√ó3.", specials:[SPECIAL.LINE, SPECIAL.BOMB], obstacles:[] },
  { id:4,  target: 115, intro:"–£—Ä–æ–≤–µ–Ω—å 4 ‚Äî –∑–æ–ª–æ—Ç–∞—è —Å–Ω–µ–∂–∏–Ω–∫–∞. –°–æ–±–µ—Ä–∏—Ç–µ 5 –≤ —Ä—è–¥ ‚Üí –ø–æ—è–≤–∏—Ç—Å—è —Å–Ω–µ–∂–∏–Ω–∫–∞, –æ–Ω–∞ –æ—á–∏—â–∞–µ—Ç –≤–µ—Å—å —ç–∫—Ä–∞–Ω.", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[] },
  { id:5,  target: 135, intro:"–£—Ä–æ–≤–µ–Ω—å 5 ‚Äî –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ ¬´–°–Ω–µ–∂–Ω—ã–π —Å—É–≥—Ä–æ–±¬ª. –û–Ω –±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–ª–µ—Ç–∫—É –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ö–æ–¥–æ–≤.", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[BLOCK.SNOW] },

  // 6‚Äì9 (—á—É—Ç—å —Å–ª–æ–∂–Ω–µ–µ) ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å —Å—É–≥—Ä–æ–±–∞–º–∏ –∏ —Ä–∞—Å—Ç–∏–º —Ü–µ–ª—å
  { id:6,  target: 155, intro:"–£—Ä–æ–≤–µ–Ω—å 6 ‚Äî –±–æ–ª—å—à–µ —Å—É–≥—Ä–æ–±–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ø–µ—Ü-—ç–ª–µ–º–µ–Ω—Ç—ã, —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–∂–¥–∞—Ç—å –ø–æ–ª–µ.", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[BLOCK.SNOW] },
  { id:7,  target: 175, intro:"–£—Ä–æ–≤–µ–Ω—å 7 ‚Äî —Å—É–≥—Ä–æ–±—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —á–∞—â–µ. –î–µ–ª–∞–π—Ç–µ 4 –∏ 5 –≤ —Ä—è–¥ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—á–∏—Å—Ç–æ–∫.", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[BLOCK.SNOW] },
  { id:8,  target: 195, intro:"–£—Ä–æ–≤–µ–Ω—å 8 ‚Äî –¥–µ—Ä–∂–∏–º —Ç–µ–º–ø: –∫–∞—Å–∫–∞–¥—ã –ø–æ—Å–ª–µ –ø–∞–¥–µ–Ω–∏—è —Ñ–∏—à–µ–∫ –¥–∞—é—Ç –±–æ–ª—å—à–µ –º–∞—Ç—á–µ–π.", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[BLOCK.SNOW] },
  { id:9,  target: 215, intro:"–£—Ä–æ–≤–µ–Ω—å 9 ‚Äî –ø–æ—á—Ç–∏ —Ñ–∏–Ω–∞–ª –ø–µ—Ä–µ–¥ –ª—å–¥–æ–º. –ì–æ—Ç–æ–≤–∏–º—Å—è –∫ –∑–∞–º–æ—Ä–æ–∑–∫–µ!", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[BLOCK.SNOW] },

  // 10 ‚Äî –ª—ë–¥ + —Å–≤–µ—á–∫–∞
  { id:10, target: 240, intro:"–£—Ä–æ–≤–µ–Ω—å 10 ‚Äî –ø–æ—è–≤–ª—è–µ—Ç—Å—è ¬´–õ–µ–¥—è–Ω–∞—è –∫–ª–µ—Ç–∫–∞¬ª (3 —Å–ª–æ—è) –∏ ¬´–°–≤–µ—á–∫–∞¬ª. –°–≤–µ—á–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å–Ω–∏–º–∞–µ—Ç 1 —Å–ª–æ–π –ª—å–¥–∞ –≤ –æ–±–ª–∞—Å—Ç–∏ 3√ó3.", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR, SPECIAL.CANDLE], obstacles:[BLOCK.SNOW, BLOCK.ICE] },
];

const width = 8;
const grid = document.getElementById('grid');
const scoreDisplay = document.getElementById('score');
const levelDisplay = document.getElementById('level');
const targetDisplay = document.getElementById('target');

const overlay = document.getElementById('overlay');
const introTitle = document.getElementById('introTitle');
const introText  = document.getElementById('introText');
const introList  = document.getElementById('introList');
const introBtn   = document.getElementById('introBtn');

let squares = [];
let score = 0;
let levelIndex = 0;

let selectedSquare = null;

let squareIdBeingDragged = null;
let squareIdBeingReplaced = null;

// –∑–∞—â–∏—Ç–∞ –æ—Ç ‚Äú–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö‚Äù —Ö–æ–¥–æ–≤ –≤–æ –≤—Ä–µ–º—è –∫–∞—Å–∫–∞–¥–æ–≤
let isResolving = false;

/* =========================================================================
   –ú–û–î–ï–õ–¨ –ö–õ–ï–¢–ö–ò (dataset):
   - data-color:   normal —Ü–≤–µ—Ç (snowflake/thermos/...)
   - data-type:    normal | special_...
   - data-block:   '' | snow | ice
   - data-turns:   –¥–ª—è snow (—Å–∫–æ–ª—å–∫–æ —Ö–æ–¥–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å)
   - data-ice:     –¥–ª—è ice (hp 3..0) ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∂–µ –≤ data-icehp
   - data-icehp:   hp –ª—å–¥–∞ (3..0)
============================================================================ */

function setCell(square, colorKey, type='normal'){
  square.dataset.color = colorKey || '';
  square.dataset.type = type || 'normal';
  const img = resolveImage(square.dataset.color, square.dataset.type);
  square.style.backgroundImage = img ? `url('${img}')` : '';
}

function resolveImage(colorKey, type){
  if(!colorKey) return '';
  // —Å–ø–µ—Ü-—ç–ª–µ–º–µ–Ω—Ç—ã —Ä–∏—Å—É—é—Ç—Å—è —Å–≤–æ–∏–º PNG, –æ–±—ã—á–Ω—ã–µ ‚Äî –ø–æ –∫–ª—é—á—É
  if(type === SPECIAL.LINE)   return IMG.goldSteps;
  if(type === SPECIAL.BOMB)   return IMG.giftBag;
  if(type === SPECIAL.CLEAR)  return IMG.goldSnowflake;
  if(type === SPECIAL.CANDLE) return IMG.candle;

  return IMG[colorKey] || '';
}

function isBlocked(i){
  const sq = squares[i];
  return (sq.dataset.block === BLOCK.SNOW && (+sq.dataset.turns || 0) > 0)
      || (sq.dataset.block === BLOCK.ICE  && (+sq.dataset.icehp || 0) > 0);
}

function clearCell(i){
  const sq = squares[i];
  setCell(sq, '', 'normal');
  // –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è —Ç—É—Ç ‚Äî –æ–Ω–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–ª–æ–µ–º
}

function hasCandy(i){
  return squares[i].dataset.color !== '';
}

function randomNormal(){
  return NORMAL_COLORS[Math.floor(Math.random() * NORMAL_COLORS.length)];
}

/* =========================================================================
   –£–†–û–í–ù–ò: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª—è + –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
============================================================================ */
function currentLevel(){
  return LEVELS[levelIndex] || LEVELS[LEVELS.length-1];
}

function showIntro(){
  const lvl = currentLevel();
  introTitle.textContent = `–£—Ä–æ–≤–µ–Ω—å ${lvl.id}`;
  introText.textContent = lvl.intro;

  // —Å–ø–∏—Å–æ–∫ ‚Äú–ø—Ä–∞–≤–∏–ª‚Äù —É—Ä–æ–≤–Ω—è ‚Äî —á—Ç–æ–±—ã –±—ã–ª–æ –≤–∞—É –∏ –ø–æ–Ω—è—Ç–Ω–æ
  introList.innerHTML = '';
  const items = [];
  items.push('–°–æ–±–µ—Ä–∏—Ç–µ 3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Ñ–∏—à–∫–∏ –ø–æ–¥—Ä—è–¥ ‚Äî –æ–Ω–∏ –∏—Å—á–µ–∑–Ω—É—Ç, –∞ –Ω–æ–≤—ã–µ —É–ø–∞–¥—É—Ç —Å–≤–µ—Ä—Ö—É.');

  const s = lvl.specials;
  if(s.includes(SPECIAL.LINE))  items.push('4 –≤ —Ä—è–¥ ‚Üí ¬´–ó–æ–ª–æ—Ç—ã–µ —à–∞–≥–∏¬ª. –ü–µ—Ä–µ–¥–≤–∏–Ω—å—Ç–µ –∏—Ö —Å–ª–µ–¥—É—é—â–∏–º —Ö–æ–¥–æ–º ‚Üí –æ—á–∏—Å—Ç–∏—Ç—Å—è —Å—Ç—Ä–æ–∫–∞.');
  if(s.includes(SPECIAL.BOMB))  items.push('L/T-–∫–æ–º–±–∏–Ω–∞—Ü–∏—è ‚Üí ¬´–ú–µ—à–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤¬ª (–≤–∑—Ä—ã–≤ 3√ó3).');
  if(s.includes(SPECIAL.CLEAR)) items.push('5 –≤ —Ä—è–¥ ‚Üí ¬´–ó–æ–ª–æ—Ç–∞—è —Å–Ω–µ–∂–∏–Ω–∫–∞¬ª (–æ—á–∏—â–∞–µ—Ç –≤–µ—Å—å —ç–∫—Ä–∞–Ω).');
  if(lvl.obstacles.includes(BLOCK.SNOW)) items.push('–°—É–≥—Ä–æ–±—ã –±–ª–æ–∫–∏—Ä—É—é—Ç –∫–ª–µ—Ç–∫–∏ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ö–æ–¥–æ–≤ (–∏—Ö –Ω–µ–ª—å–∑—è –¥–≤–∏–≥–∞—Ç—å).');
  if(lvl.obstacles.includes(BLOCK.ICE))  items.push('–õ—ë–¥ (3 —Å–ª–æ—è) –ª–æ–º–∞–µ—Ç—Å—è –ø–æ 1 —Å–ª–æ—é –æ—Ç —ç—Ñ—Ñ–µ–∫—Ç–æ–≤. –°–≤–µ—á–∫–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞–∑–º–æ—Ä–∞–∂–∏–≤–∞—Ç—å –ª—ë–¥.');

  items.forEach(t=>{
    const li = document.createElement('li');
    li.textContent = t;
    introList.appendChild(li);
  });

  overlay.classList.add('show');
  overlay.setAttribute('aria-hidden','false');
}

introBtn.onclick = () => {
  overlay.classList.remove('show');
  overlay.setAttribute('aria-hidden','true');
};

overlay.addEventListener('click', (e)=>{
  if(e.target === overlay){
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden','true');
  }
});

function setupHUD(){
  const lvl = currentLevel();
  levelDisplay.textContent = lvl.id;
  targetDisplay.textContent = lvl.target;
  scoreDisplay.textContent = score;
}

function placeObstacles(){
  const lvl = currentLevel();

  // –æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –±–ª–æ–∫–∏
  for(let i=0;i<squares.length;i++){
    squares[i].dataset.block = '';
    squares[i].dataset.turns = '';
    squares[i].dataset.icehp = '';
    squares[i].dataset.ice = '';
  }

  // —Å—É–≥—Ä–æ–±—ã ‚Äî —Ä–∞–Ω–¥–æ–º–Ω–æ (—É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø–æ —É—Ä–æ–≤–Ω—é)
  if(lvl.obstacles.includes(BLOCK.SNOW)){
    const count = Math.min(10, 3 + Math.floor((lvl.id-5)*1.2)); // 5lvl=3.. –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –±–æ–ª—å—à–µ
    dropSnow(count);
  }

  // –ª—ë–¥ ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞ 10 —É—Ä–æ–≤–Ω–µ
  if(lvl.obstacles.includes(BLOCK.ICE)){
    const count = 10; // –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å
    dropIce(count);
  }
}

function dropSnow(count){
  let placed = 0;
  let tries = 0;
  while(placed < count && tries < 500){
    tries++;
    const i = Math.floor(Math.random() * (width*width));
    // –Ω–µ —Å—Ç–∞–≤–∏–º –Ω–∞ –≤–µ—Ä—Ö–Ω—é—é —Å—Ç—Ä–æ–∫—É —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Å–ø–∞–≤–Ω
    if(i < width) continue;
    if(squares[i].dataset.block) continue;

    squares[i].dataset.block = BLOCK.SNOW;
    squares[i].dataset.turns = 3; // –±–ª–æ–∫ –Ω–∞ 3 —Ö–æ–¥–∞
    placed++;
  }
}

function dropIce(count){
  let placed = 0;
  let tries = 0;
  while(placed < count && tries < 800){
    tries++;
    const i = Math.floor(Math.random() * (width*width));
    if(squares[i].dataset.block) continue;
    // –ª—ë–¥ –Ω–µ —Å—Ç–∞–≤–∏–º –≤ –ø–µ—Ä–≤–æ–º —Ä—è–¥—É, —á—Ç–æ–±—ã –ø—Ä–æ—â–µ ‚Äú–≤—ä–µ—Ö–∞—Ç—å‚Äù –≤ —É—Ä–æ–≤–µ–Ω—å
    if(i < width) continue;

    squares[i].dataset.block = BLOCK.ICE;
    squares[i].dataset.icehp = 3;
    squares[i].dataset.ice = '3';
    placed++;
  }
}

function tickObstaclesAfterMove(){
  // —Å—É–≥—Ä–æ–±—ã: -1 —Ö–æ–¥
  for(let i=0;i<squares.length;i++){
    if(squares[i].dataset.block === BLOCK.SNOW){
      let t = (+squares[i].dataset.turns || 0);
      if(t > 0){
        t--;
        squares[i].dataset.turns = String(t);
        if(t <= 0){
          squares[i].dataset.block = '';
          squares[i].dataset.turns = '';
        }
      }
    }
  }
}

function damageIceAt(i, amount=1){
  const sq = squares[i];
  if(sq.dataset.block !== BLOCK.ICE) return;

  let hp = (+sq.dataset.icehp || 0);
  if(hp <= 0) return;

  hp = Math.max(0, hp - amount);
  sq.dataset.icehp = String(hp);
  sq.dataset.ice = hp ? String(hp) : '';

  if(hp === 0){
    sq.dataset.block = '';
    sq.dataset.icehp = '';
    sq.dataset.ice = '';
  }
}

/* =========================================================================
   –°–û–ó–î–ê–ù–ò–ï –ü–û–õ–Ø
============================================================================ */
function createBoard(){
  grid.innerHTML = '';
  squares = [];

  for(let i=0;i<width*width;i++){
    const sq = document.createElement('div');
    sq.className = 'cell';
    sq.setAttribute('draggable', true);
    sq.setAttribute('id', i);

    // –æ–±—ã—á–Ω–∞—è —Ñ–∏—à–∫–∞
    setCell(sq, randomNormal(), 'normal');

    // —Å–ª—É—à–∞—Ç–µ–ª–∏
    sq.addEventListener('click', selectSquare);

    sq.addEventListener('dragstart', dragStart);
    sq.addEventListener('dragover', (e)=>e.preventDefault());
    sq.addEventListener('dragenter', (e)=>e.preventDefault());
    sq.addEventListener('drop', dragDrop);
    sq.addEventListener('dragend', dragEnd);

    grid.appendChild(sq);
    squares.push(sq);
  }

  placeObstacles();

  // —á—Ç–æ–±—ã –Ω–µ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å —Å –≥–æ—Ç–æ–≤—ã–º–∏ –º–∞—Ç—á–∞–º–∏ ‚Äî —Å–ª–µ–≥–∫–∞ ‚Äú–ø–µ—Ä–µ–º–µ—à–∞–µ–º‚Äù
  stabilizeNoInitialMatches();
}

/* =========================================================================
   –í–´–ë–û–† / –ü–ï–†–ï–°–¢–ê–ù–û–í–ö–ê
============================================================================ */
function selectSquare(e){
  if(isResolving) return;

  const id = parseInt(e.currentTarget.id, 10);

  // –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∫–ª–µ—Ç–∫—É –Ω–µ–ª—å–∑—è —Ç—Ä–æ–≥–∞—Ç—å
  if(isBlocked(id)) return;

  if(selectedSquare === null){
    selectedSquare = id;
    squares[id].classList.add('selected');
    return;
  }

  if(selectedSquare === id){
    squares[selectedSquare].classList.remove('selected');
    selectedSquare = null;
    return;
  }

  const validMoves = [selectedSquare-1, selectedSquare+1, selectedSquare-width, selectedSquare+width];
  const isAdjacent = validMoves.includes(id);

  // –∑–∞–ø—Ä–µ—Ç ‚Äú—á–µ—Ä–µ–∑ –∫—Ä–∞–π‚Äù
  if(isAdjacent){
    if(selectedSquare % width === 0 && id === selectedSquare - 1) return;
    if(selectedSquare % width === width-1 && id === selectedSquare + 1) return;

    // –≤—Ç–æ—Ä–æ–π —Ç–æ–∂–µ –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
    if(isBlocked(id)) return;

    doMove(selectedSquare, id);
    squares[selectedSquare].classList.remove('selected');
    selectedSquare = null;
  } else {
    squares[selectedSquare].classList.remove('selected');
    selectedSquare = id;
    squares[id].classList.add('selected');
  }
}

function dragStart(e){
  if(isResolving) return;
  const id = parseInt(this.id,10);
  if(isBlocked(id)) return;
  squareIdBeingDragged = this.id;
}

function dragDrop(e){
  if(isResolving) return;
  const id = parseInt(this.id,10);
  if(isBlocked(id)) return;
  squareIdBeingReplaced = this.id;
}

function dragEnd(){
  if(isResolving) { squareIdBeingDragged=null; squareIdBeingReplaced=null; return; }
  if(squareIdBeingDragged === null || squareIdBeingReplaced === null) return;

  const from = parseInt(squareIdBeingDragged,10);
  const to   = parseInt(squareIdBeingReplaced,10);

  squareIdBeingDragged = null;
  squareIdBeingReplaced = null;

  if(isBlocked(from) || isBlocked(to)) return;

  const validMoves = [from-1, from+1, from-width, from+width];
  let validMove = validMoves.includes(to);

  if(from % width === 0 && to === from - 1) validMove = false;
  if(from % width === width-1 && to === from + 1) validMove = false;

  if(!validMove) return;

  doMove(from, to);
}

/* =========================================================================
   –•–û–î: swap ‚Üí (–µ—Å–ª–∏ —Å–ø–µ—Ü –ø–µ—Ä–µ–¥–≤–∏–Ω—É—Ç ‚Äî –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å) ‚Üí –∏–Ω–∞—á–µ –∏—Å–∫–∞—Ç—å –º–∞—Ç—á–∏
============================================================================ */
function doSwap(a,b){
  const A = squares[a], B = squares[b];

  const tempColor = A.dataset.color;
  const tempType  = A.dataset.type;

  A.dataset.color = B.dataset.color;
  A.dataset.type  = B.dataset.type;
  B.dataset.color = tempColor;
  B.dataset.type  = tempType;

  // –æ–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏
  A.style.backgroundImage = A.dataset.color ? `url('${resolveImage(A.dataset.color, A.dataset.type)}')` : '';
  B.style.backgroundImage = B.dataset.color ? `url('${resolveImage(B.dataset.color, B.dataset.type)}')` : '';
}

function doMove(from,to){
  if(isResolving) return;
  isResolving = true;

  // swap
  doSwap(from,to);

  // —ç—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ö–æ–¥–æ–º ‚Üí —É–º–µ–Ω—å—à–∞–µ–º —Ç–∞–π–º–µ—Ä—ã —Å—É–≥—Ä–æ–±–æ–≤
  tickObstaclesAfterMove();

  const movedSpecial = (squares[to].dataset.type !== 'normal' || squares[from].dataset.type !== 'normal');

  // –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª–∏ —Å–ø–µ—Ü ‚Äî –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º (–∫–∞–∫ ‚Äú—Å–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥‚Äù)
  // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–ø–µ—Ü, –∫–æ—Ç–æ—Ä—ã–π –æ–∫–∞–∑–∞–ª—Å—è –≤ —Ç–æ—á–∫–µ TO (—Ç–∞–º ‚Äú–∑–∞–≤–µ—Ä—à–∏–ª—Å—è‚Äù –ø–µ—Ä–µ–Ω–æ—Å)
  let activated = false;
  if(squares[to].dataset.type !== 'normal'){
    activated = activateSpecialAt(to);
  } else if(squares[from].dataset.type !== 'normal'){
    // –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å—Ç—Ä–∞–Ω–Ω–æ–µ ‚Äî –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Ç–æ—Ä–æ–π
    activated = activateSpecialAt(from);
  }

  // –ï—Å–ª–∏ —Å–ø–µ—Ü –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª—Å—è ‚Äî —Å—Ä–∞–∑—É —Ä–µ–∑–æ–ª–≤–∏–º –∫–∞—Å–∫–∞–¥—ã
  if(activated){
    resolveBoard().then(()=>{
      isResolving = false;
      checkLevelComplete();
    });
    return;
  }

  // –ï—Å–ª–∏ —Å–ø–µ—Ü –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª—Å—è ‚Äî –æ–±—ã—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ç—á–∞
  const matches = findAllMatches();
  if(matches.length === 0){
    // –æ—Ç–∫–∞—Ç
    doSwap(from,to);
    isResolving = false;
    return;
  }

  // –µ—Å–ª–∏ –º–∞—Ç—á –µ—Å—Ç—å ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º –∏ –∫–∞—Å–∫–∞–¥–∏–º
  applyMatches(matches, {from, to}).then(()=>{
    resolveBoard().then(()=>{
      isResolving = false;
      checkLevelComplete();
    });
  });
}

/* =========================================================================
   –ê–ö–¢–ò–í–ê–¶–ò–Ø –°–ü–ï–¶-–≠–õ–ï–ú–ï–ù–¢–û–í
============================================================================ */
function activateSpecialAt(i){
  const sq = squares[i];
  const type = sq.dataset.type;
  if(type === 'normal') return false;

  // –Ω–µ–ª—å–∑—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ –∫–ª–µ—Ç–∫–∞ ‚Äú–∑–∞–ø–µ—Ä—Ç–∞‚Äù –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ–º
  if(isBlocked(i)) return false;

  if(type === SPECIAL.LINE){
    // –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é —Å—Ç—Ä–æ–∫—É
    const row = Math.floor(i / width);
    const start = row * width;
    for(let c=0;c<width;c++){
      const idx = start + c;
      // –ø—Ä–∏ —ç—Ñ—Ñ–µ–∫—Ç–µ ‚Äú–±—å—ë–º‚Äù –ª—ë–¥ –Ω–∞ 1 —Å–ª–æ–π, –¥–∞–∂–µ –µ—Å–ª–∏ —Ñ–∏—à–∫–∞ –Ω–µ –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑-–∑–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
      if(squares[idx].dataset.block === BLOCK.ICE) damageIceAt(idx, 1);
      if(!isBlocked(idx)) clearCell(idx);
    }
    // —Å–∞–º–∞ —Å–ø–µ—Ü-–∫–ª–µ—Ç–∫–∞ –∏—Å—á–µ–∑–∞–µ—Ç
    clearCell(i);
    addScore(8);
    return true;
  }

  if(type === SPECIAL.BOMB){
    // –≤–∑—Ä—ã–≤ 3√ó3
    const r0 = Math.floor(i/width);
    const c0 = i % width;
    for(let dr=-1; dr<=1; dr++){
      for(let dc=-1; dc<=1; dc++){
        const r = r0 + dr, c = c0 + dc;
        if(r<0||r>=width||c<0||c>=width) continue;
        const idx = r*width + c;
        if(squares[idx].dataset.block === BLOCK.ICE) damageIceAt(idx, 1);
        if(!isBlocked(idx)) clearCell(idx);
      }
    }
    clearCell(i);
    addScore(10);
    return true;
  }

  if(type === SPECIAL.CLEAR){
    // –æ—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —ç–∫—Ä–∞–Ω
    for(let idx=0; idx<width*width; idx++){
      if(squares[idx].dataset.block === BLOCK.ICE) damageIceAt(idx, 1); // –ª—ë–¥ —Ç–µ—Ä—è–µ—Ç 1 —Å–ª–æ–π
      if(!isBlocked(idx)) clearCell(idx);
    }
    addScore(16);
    return true;
  }

  if(type === SPECIAL.CANDLE){
    // —Ä–∞–∑–º–æ—Ä–æ–∑–∏—Ç—å –ª—ë–¥ 3√ó3 (–∏ —á—É—Ç—å –æ—á–∏—Å—Ç–∏—Ç—å —Ä—è–¥–æ–º, –µ—Å–ª–∏ –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ)
    const r0 = Math.floor(i/width);
    const c0 = i % width;
    for(let dr=-1; dr<=1; dr++){
      for(let dc=-1; dc<=1; dc++){
        const r = r0 + dr, c = c0 + dc;
        if(r<0||r>=width||c<0||c>=width) continue;
        const idx = r*width + c;

        // —Å–≤–µ—á–∫–∞ —Å–Ω–∏–º–∞–µ—Ç 1 —Å–ª–æ–π –ª—å–¥–∞
        if(squares[idx].dataset.block === BLOCK.ICE) damageIceAt(idx, 1);

        // –∏ –ø—Ä–∏ —ç—Ç–æ–º –æ—á–∏—â–∞–µ—Ç –æ–±—ã—á–Ω—ã–µ —Ñ–∏—à–∫–∏, –µ—Å–ª–∏ –∫–ª–µ—Ç–∫–∞ –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞
        if(!isBlocked(idx)) clearCell(idx);
      }
    }
    clearCell(i);
    addScore(12);
    return true;
  }

  return false;
}

/* =========================================================================
   –ü–û–ò–°–ö –ú–ê–¢–ß–ï–ô (3/4/5 + L/T)
   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –≥—Ä—É–ø–ø: { cells:[...], kind:'row'|'col'|'lt', len, colorKey }
============================================================================ */
function findAllMatches(){
  const groups = [];

  // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
  for(let r=0;r<width;r++){
    let c=0;
    while(c<width){
      const idx = r*width + c;
      const key = squares[idx].dataset.color;
      const type = squares[idx].dataset.type;

      // –º–∞—Ç—á–∏–º —Ç–æ–ª—å–∫–æ normal —Ñ–∏—à–∫–∏ (—Å–ø–µ—Ü –Ω–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ –º–∞—Ç—á–∞—Ö –ø–æ —Ü–≤–µ—Ç—É)
      if(!key || type !== 'normal' || isBlocked(idx)){
        c++;
        continue;
      }

      let run = [idx];
      let cc = c+1;
      while(cc<width){
        const j = r*width + cc;
        if(squares[j].dataset.color === key && squares[j].dataset.type === 'normal' && !isBlocked(j)){
          run.push(j);
          cc++;
        } else break;
      }

      if(run.length >= 3){
        groups.push({cells:run, kind:'row', len:run.length, colorKey:key});
      }
      c = cc;
    }
  }

  // –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
  for(let c=0;c<width;c++){
    let r=0;
    while(r<width){
      const idx = r*width + c;
      const key = squares[idx].dataset.color;
      const type = squares[idx].dataset.type;

      if(!key || type !== 'normal' || isBlocked(idx)){
        r++;
        continue;
      }

      let run = [idx];
      let rr = r+1;
      while(rr<width){
        const j = rr*width + c;
        if(squares[j].dataset.color === key && squares[j].dataset.type === 'normal' && !isBlocked(j)){
          run.push(j);
          rr++;
        } else break;
      }

      if(run.length >= 3){
        groups.push({cells:run, kind:'col', len:run.length, colorKey:key});
      }
      r = rr;
    }
  }

  // L/T: –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è row –∏ col –≥—Ä—É–ø–ø –ø–æ –æ–¥–Ω–æ–π –∫–ª–µ—Ç–∫–µ
  // —Å–æ–±–µ—Ä—ë–º –∫–∞—Ä—Ç—É: cell -> —Å–∫–æ–ª—å–∫–æ –≥—Ä—É–ø–ø –µ—ë —Å–æ–¥–µ—Ä–∂–∏—Ç
  const cellToGroups = new Map();
  groups.forEach((g, gi)=>{
    g.cells.forEach(i=>{
      if(!cellToGroups.has(i)) cellToGroups.set(i, []);
      cellToGroups.get(i).push(gi);
    });
  });

  const ltGroups = [];
  cellToGroups.forEach((giList, cell)=>{
    if(giList.length >= 2){
      // –ø—Ä–æ–≤–µ—Ä–∏–º —á—Ç–æ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –ø–æ –æ–¥–Ω–æ–º—É —Ü–≤–µ—Ç—É (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ—Ç –∂–µ colorKey)
      const keys = new Set(giList.map(gi=>groups[gi].colorKey));
      if(keys.size === 1){
        // –æ–±—ä–µ–¥–∏–Ω—è–µ–º –¥–≤–µ –≥—Ä—É–ø–ø—ã –≤–æ–∫—Ä—É–≥ —Ç–æ—á–∫–∏ ‚Äî —ç—Ç–æ L/T
        const union = new Set();
        giList.forEach(gi => groups[gi].cells.forEach(x=>union.add(x)));
        ltGroups.push({cells:[...union], kind:'lt', len:union.size, colorKey:[...keys][0], pivot:cell});
      }
    }
  });

  // —É–±–∏—Ä–∞–µ–º –∏–∑ –æ–±—ã—á–Ω—ã—Ö –≥—Ä—É–ø–ø —Ç–µ, —á—Ç–æ –≤—Ö–æ–¥—è—Ç –≤ lt, —á—Ç–æ–±—ã –Ω–µ ‚Äú–¥–≤–æ–π–Ω–æ–π‚Äù –æ—á–∏—Å—Ç–∫–∏
  if(ltGroups.length){
    // –ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞: –µ—Å–ª–∏ —É –≥—Ä—É–ø–ø—ã –µ—Å—Ç—å –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å lt ‚Äî –µ—ë –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ
    const blockedGroupIdx = new Set();
    ltGroups.forEach(lt=>{
      groups.forEach((g, gi)=>{
        if(g.colorKey !== lt.colorKey) return;
        const inter = g.cells.some(x=>lt.cells.includes(x));
        if(inter) blockedGroupIdx.add(gi);
      });
    });
    const filtered = groups.filter((g,gi)=>!blockedGroupIdx.has(gi));
    return [...filtered, ...ltGroups];
  }

  return groups;
}

/* =========================================================================
   –°–ü–ê–í–ù –°–ü–ï–¶–û–í –ò –û–ß–ò–°–¢–ö–ê –ú–ê–¢–ß–ê
   –ü—Ä–∞–≤–∏–ª–∞:
   - 5 –ø–æ–¥—Ä—è–¥ ‚Üí special_clear
   - 4 –ø–æ–¥—Ä—è–¥ ‚Üí special_line (—Å 10 —É—Ä–æ–≤–Ω—è: –µ—Å–ª–∏ —Å–æ–±—Ä–∞–Ω 4 –∏–∑ THERMOS ‚Äî —Å–≤–µ—á–∫–∞, —á—Ç–æ–±—ã –ª–æ–≥–∏—á–Ω–æ)
   - L/T ‚Üí special_bomb
============================================================================ */
function levelHasSpecial(type){
  return currentLevel().specials.includes(type);
}

function addScore(n){
  score += n;
  scoreDisplay.textContent = score;
}

async function applyMatches(matches, moveInfo){
  const lvl = currentLevel();

  // –æ–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –∫–ª–µ—Ç–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–¥–æ –æ—á–∏—Å—Ç–∏—Ç—å
  // –Ω–æ —Å–ø–µ—Ü-—ç–ª–µ–º–µ–Ω—Ç (–µ—Å–ª–∏ —Ä–æ–∂–¥–∞–µ—Ç—Å—è) –º—ã –æ—Å—Ç–∞–≤–∏–º –Ω–∞ –º–µ—Å—Ç–µ
  const toClear = new Set();

  // —Ö–æ—Ç–∏–º —Ä–æ–∂–∞—Ç—å —Å–ø–µ—Ü –≤ —Ç–æ—á–∫–µ ‚Äú—É–ø—Ä–∞–≤–ª—è–µ–º–æ–π –∏–≥—Ä–æ–∫–æ–º‚Äù
  // –≤—ã–±–∏—Ä–∞–µ–º pivot: –µ—Å–ª–∏ –≤ –≥—Ä—É–ø–ø–µ –µ—Å—Ç—å moveInfo.to –∏–ª–∏ moveInfo.from ‚Äî —Å—Ç–∞–≤–∏–º —Ç—É–¥–∞
  function chooseSpawnCell(group){
    const {from, to} = moveInfo || {};
    if(typeof to === 'number' && group.cells.includes(to)) return to;
    if(typeof from === 'number' && group.cells.includes(from)) return from;
    // –∏–Ω–∞—á–µ —Ü–µ–Ω—Ç—Ä
    return group.cells[Math.floor(group.cells.length/2)];
  }

  // —Å–Ω–∞—á–∞–ª–∞ —Ä–µ—à–∏–º, –∫–∞–∫–∏–µ —Å–ø–µ—Ü-—ç–ª–µ–º–µ–Ω—Ç—ã —Ä–æ–∂–¥–∞—é—Ç—Å—è
  const spawns = []; // {at, type}
  for(const g of matches){
    if(g.kind === 'lt'){
      if(levelHasSpecial(SPECIAL.BOMB)){
        spawns.push({ at: g.pivot ?? chooseSpawnCell(g), type: SPECIAL.BOMB });
      }
      g.cells.forEach(i=>toClear.add(i));
      continue;
    }

    if(g.len >= 5){
      if(levelHasSpecial(SPECIAL.CLEAR)){
        spawns.push({ at: chooseSpawnCell(g), type: SPECIAL.CLEAR });
      }
      g.cells.forEach(i=>toClear.add(i));
      continue;
    }

    if(g.len === 4){
      // –£—Ä–æ–≤–µ–Ω—å 2+: line
      if(levelHasSpecial(SPECIAL.LINE)){
        // –£—Ä–æ–≤–µ–Ω—å 10+: —Å–≤–µ—á–∫–∞ –∫–∞–∫ ‚Äú–ø–æ–º–æ—â—å –ø—Ä–æ—Ç–∏–≤ –ª—å–¥–∞‚Äù
        // –õ–æ–≥–∏–∫–∞: –µ—Å–ª–∏ —Å–æ–±—Ä–∞–ª–∏ 4 –∏–∑ —Ç–µ—Ä–º–æ—Å–æ–≤ ‚Äî —Å–æ–∑–¥–∞—ë–º —Å–≤–µ—á–∫—É.
        const spawnAt = chooseSpawnCell(g);
        if(levelHasSpecial(SPECIAL.CANDLE) && g.colorKey === 'thermos'){
          spawns.push({ at: spawnAt, type: SPECIAL.CANDLE });
        } else {
          spawns.push({ at: spawnAt, type: SPECIAL.LINE });
        }
      }
      g.cells.forEach(i=>toClear.add(i));
      continue;
    }

    // –æ–±—ã—á–Ω—ã–µ 3
    g.cells.forEach(i=>toClear.add(i));
  }

  // –ø—Ä–∏–º–µ–Ω—è–µ–º –æ—á–∏—Å—Ç–∫—É, –Ω–æ –Ω–µ –æ—á–∏—â–∞–µ–º –∫–ª–µ—Ç–∫–∏, –≥–¥–µ –±—É–¥–µ—Ç —Å–ø–µ—Ü
  const spawnCells = new Set(spawns.map(s=>s.at));

  // –∞–Ω–∏–º–∞—Ü–∏—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
  const clearList = [...toClear].filter(i=>!spawnCells.has(i));
  clearList.forEach(i=>squares[i].classList.add('fade-out'));

  await sleep(220);

  for(const i of clearList){
    // —ç—Ñ—Ñ–µ–∫—Ç—ã —Ç–∞–∫–∂–µ –±—å—é—Ç –ª—ë–¥
    if(squares[i].dataset.block === BLOCK.ICE) damageIceAt(i, 1);
    if(!isBlocked(i)) clearCell(i);
    squares[i].classList.remove('fade-out');
  }

  // –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å–ø–µ—Ü
  for(const s of spawns){
    // –µ—Å–ª–∏ –∫–ª–µ—Ç–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ ‚Äî —Å–ø–µ—Ü –Ω–µ —Å—Ç–∞–≤–∏–º (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –≥–ª—é–∫–æ–≤)
    if(isBlocked(s.at)) continue;
    // —Å–∞–º–∞ –∫–ª–µ—Ç–∫–∞ –¥–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞—Ç—å—Å—è ‚Äú–∑–∞–Ω—è—Ç–æ–π‚Äù —Å–ø–µ—Ü–æ–º ‚Äî –µ—ë —Ü–≤–µ—Ç –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –∏—Å—Ö–æ–¥–Ω—ã–π –∏–ª–∏ –ø—É—Å—Ç–æ–π
    // –æ—Å—Ç–∞–≤–∏–º —Ü–≤–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π, —á—Ç–æ–±—ã –±—ã–ª–æ –ø—Ä–æ—â–µ –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å, –Ω–æ —Ç–∏–ø –∑–∞–¥–∞—ë—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É
    if(!squares[s.at].dataset.color) squares[s.at].dataset.color = randomNormal();
    squares[s.at].dataset.type = s.type;
    squares[s.at].style.backgroundImage = `url('${resolveImage(squares[s.at].dataset.color, squares[s.at].dataset.type)}')`;
  }

  // –æ—á–∫–∏
  // –∑–∞ –º–∞—Ç—á
  const base = clearList.length;
  addScore(base); // 1 –æ—á–∫–æ –∑–∞ —Ñ–∏—à–∫—É
}

function sleep(ms){ return new Promise(res=>setTimeout(res, ms)); }

/* =========================================================================
   –ì–†–ê–í–ò–¢–ê–¶–ò–Ø + –ö–ê–°–ö–ê–î–´
============================================================================ */
function moveDown(){
  // —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö
  for(let i = width*width - 1; i >= 0; i--){
    // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª–µ—Ç–∫–∏
    if(isBlocked(i)) continue;

    const below = i + width;
    if(below >= width*width) continue;
    if(isBlocked(below)) continue;

    // –µ—Å–ª–∏ –≤–Ω–∏–∑—É –ø—É—Å—Ç–æ ‚Äî –ø–∞–¥–∞–µ–º
    if(!hasCandy(below) && hasCandy(i)){
      squares[below].dataset.color = squares[i].dataset.color;
      squares[below].dataset.type  = squares[i].dataset.type;
      squares[below].style.backgroundImage = squares[i].style.backgroundImage;

      clearCell(i);
    }
  }
}

function generateNewCandies(){
  for(let i=0;i<width;i++){
    if(isBlocked(i)) continue;
    if(!hasCandy(i)){
      setCell(squares[i], randomNormal(), 'normal');
    }
  }
}

async function resolveBoard(){
  // –ø–æ–≤—Ç–æ—Ä—è–µ–º: –ø–∞–¥–µ–Ω–∏–µ ‚Üí –ø–æ—è–≤–ª–µ–Ω–∏–µ ‚Üí –º–∞—Ç—á–∏ ‚Üí –æ—á–∏—Å—Ç–∫–∞ ‚Üí —Å–Ω–æ–≤–∞ –ø–∞–¥–µ–Ω–∏–µ‚Ä¶
  for(let step=0; step<25; step++){
    // 1) –ø–∞–¥–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∏–∫–æ–≤ (—á—Ç–æ–±—ã ‚Äú–¥–æ–∫–∞–ø–∞–ª–æ‚Äù)
    for(let k=0;k<10;k++){
      moveDown();
      generateNewCandies();
      await sleep(40);
    }

    // 2) –º–∞—Ç—á–∏ –æ—Ç –∫–∞—Å–∫–∞–¥–∞
    const matches = findAllMatches();
    if(matches.length === 0) break;

    await applyMatches(matches, null);
    await sleep(90);
  }
}

/* =========================================================================
   –°–¢–ê–†–¢ / –ü–ï–†–ï–•–û–î –£–†–û–í–ù–Ø
============================================================================ */
function stabilizeNoInitialMatches(){
  // –≥—Ä—É–±–æ: –ø–æ–∫–∞ –µ—Å—Ç—å –º–∞—Ç—á ‚Äî –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏–º —á–∞—Å—Ç—å –∫–ª–µ—Ç–æ–∫ (–±–µ–∑ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π)
  for(let tries=0; tries<30; tries++){
    const matches = findAllMatches();
    if(matches.length === 0) return;

    // –¥–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã ‚Äú–ø–µ—Ä–µ–º–µ—à–∞–µ–º‚Äù 1‚Äì2 –∫–ª–µ—Ç–∫–∏
    matches.forEach(g=>{
      const pick = g.cells[Math.floor(Math.random()*g.cells.length)];
      if(!isBlocked(pick)){
        setCell(squares[pick], randomNormal(), 'normal');
      }
    });
  }
}

function checkLevelComplete(){
  const lvl = currentLevel();
  if(score >= lvl.target){
    // —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å
    if(levelIndex < LEVELS.length-1){
      levelIndex++;
      startLevel(false);
    } else {
      // –ø–æ–±–µ–¥–∞ ‚Äî –ø–æ–∫–∞–∂–µ–º –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É
      introTitle.textContent = '–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ —É—Ä–æ–≤–Ω–∏! üéâ';
      introText.textContent  = '–ú–æ–∂–Ω–æ –∏–≥—Ä–∞—Ç—å –¥–∞–ª—å—à–µ —Ä–∞–¥–∏ –æ—á–∫–æ–≤ –∏–ª–∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.';
      introList.innerHTML = '';
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden','false');
    }
  }
}

function startLevel(resetScore){
  if(resetScore){
    score = 0;
  }
  setupHUD();
  createBoard();
  showIntro();
}

function startGame(){
  levelIndex = 0;
  score = 0;
  startLevel(true);
}

/* =========================================================================
   –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
============================================================================ */
setupHUD();
startGame();
</script>
</body>
</html>
