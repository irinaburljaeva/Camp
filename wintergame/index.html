<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–®–ê–ì–ê–ô –î–û–ú–ê: –ó–∏–º–Ω—è—è –∏–≥—Ä–∞</title>

  <style>
    *{ box-sizing:border-box; }

    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:
        linear-gradient(135deg, rgba(168,192,255,.75) 0%, rgba(63,43,150,.75) 100%),
        url("/Camp/wintergame/IMG_3671.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;

      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      min-height:100vh; margin:0; color:#fff;
      user-select:none;
    }

    h1{
      text-shadow:2px 2px 4px rgba(0,0,0,.3);
      margin:0 0 10px;
      text-align:center;
    }

    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:center;
      flex-wrap:wrap;
      margin-bottom:14px;
    }

    .pill{
      background:rgba(255,255,255,.2);
      padding:10px 16px;
      border-radius:15px;
      font-size:18px;
      box-shadow:0 4px 6px rgba(0,0,0,.1);
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
    }

    /* —Ä–∞–∑–º–µ—Ä—ã —Å–µ—Ç–∫–∏ */
    :root{
      --cell: 70px;     /* —Ä–∞–∑–º–µ—Ä –∫–ª–µ—Ç–∫–∏ */
      --pad:  5px;      /* padding —É –ø–æ–ª—è */
      --cols: 8;        /* 8x8 */
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(var(--cols), var(--cell));
      grid-template-rows: repeat(var(--cols), var(--cell));
      gap: 0;

      width:  calc(var(--cell) * var(--cols) + var(--pad) * 2);
      height: calc(var(--cell) * var(--cols) + var(--pad) * 2);

      padding: var(--pad);

      background-image: url("/Camp/wintergame/IMG_3672.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;

      border-radius:10px;
      box-shadow:0 10px 20px rgba(0,0,0,.2);
      position:relative;

      overflow:hidden;           /* ‚úÖ —á—Ç–æ–±—ã —Ö–æ–≤–µ—Ä-—Å–∫–µ–π–ª –Ω–µ –≤—ã–ª–µ–∑–∞–ª –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã */
      place-content:start;
    }

    .cell{
      width: var(--cell);
      height: var(--cell);

      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      transition:transform .18s, filter .18s, background-color .18s;
      border-radius:18px;

      background-repeat:no-repeat;
      background-position:center;
      background-size:86% 86%;
      position:relative;
      overflow:hidden;

      transform-origin:center;   /* ‚úÖ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ –ø—Ä–∏ —Å–∫–µ–π–ª–µ */
    }

    .cell:hover{
      transform:scale(1.04);
      background-color:rgba(255,255,255,.08);
    }

    .selected{
      background-color:rgba(255,255,255,.28) !important;
      transform:scale(1.06) !important;
      outline:2px solid rgba(255,255,255,.45);
      outline-offset:-2px;
    }

    .fade-out{ animation:fadeOut .45s forwards; }
    @keyframes fadeOut{ to{opacity:0; transform:scale(0)} }

    /* ---- –≤–∏–∑—É–∞–ª —Å–ø–µ—Ü–æ–≤ ---- */
    .cell[data-type="special_line"]{ filter:drop-shadow(0 0 10px rgba(255,215,0,.55)); }
    .cell[data-type="special_bomb"]{ filter:drop-shadow(0 0 10px rgba(255,255,255,.35)); }
    .cell[data-type="special_clear"]{ filter:drop-shadow(0 0 12px rgba(255,215,0,.75)); }
    .cell[data-type="special_candle"]{ filter:drop-shadow(0 0 12px rgba(255,140,0,.65)); }

/* ---- –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è (–¢–û–õ–¨–ö–û PNG, –±–µ–∑ —ç–º–æ–¥–∑–∏ –∏ ::after) ---- */
.cell[data-block="snow"],
.cell[data-block="ice"]{
  cursor: not-allowed;
  filter: saturate(.9) brightness(.95);
}

/* –ª—ë–¥ —Ä–∞–∑–Ω—ã–π –ø–æ —Å–ª–æ—è–º */
.cell[data-icehp="3"]{ }
.cell[data-icehp="2"]{ }
.cell[data-icehp="1"]{ }

    /* ---- –º–æ–¥–∞–ª–∫–∏ ---- */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:50;
    }
    .overlay.show{ display:flex; }

    .modal{
      width:min(560px, 95vw);
      background:rgba(255,255,255,.96);
      color:#1f2937;
      border-radius:18px;
      padding:18px 18px 14px;
      box-shadow:0 16px 48px rgba(0,0,0,.35);
    }
    .modal h2{ margin:0 0 8px; font-size:20px; }
    .modal p{ margin:0 0 10px; line-height:1.45; }
    .modal ul{ margin:0 0 12px; padding-left:18px; }
    .modal li{ margin:6px 0; }
    .modal .actions{ display:flex; gap:10px; margin-top:10px; }
    .modal button{
      flex:1;
      margin:0;
      padding:10px 14px;
      font-size:16px;
      background:#ff6b6b;
      color:#fff;
      border:none;
      border-radius:14px;
      cursor:pointer;
      box-shadow:0 6px 18px rgba(0,0,0,.18);
      transition:background .2s, transform .15s;
    }
    .modal button:hover{ background:#ff4757; transform:translateY(-1px); }
    .modal button:disabled{
      opacity:.5;
      cursor:not-allowed;
      transform:none !important;
      box-shadow:none;
    }

    /* ---- –∫–Ω–æ–ø–∫–∏ —Å–Ω–∏–∑—É ---- */
    .btnbar{
      display:flex;
      gap:12px;
      margin-top:18px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .btnbar button{
      padding:12px 22px;
      font-size:18px;

      background: rgba(255,255,255,.22);
      color:#fff;
      border: 1px solid rgba(255,255,255,.28);
      border-radius:18px;
      box-shadow: 0 10px 24px rgba(0,0,0,.18);

      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);

      cursor:pointer;
      transition: transform .15s, background .2s, border-color .2s;
    }
    .btnbar button:hover{
      background: rgba(255,255,255,.30);
      border-color: rgba(255,255,255,.40);
      transform: translateY(-1px);
    }
    .btnbar button:active{
      transform: translateY(0px) scale(.98);
    }

    /* =========================
       FX: –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å —Å–ø–µ—Ü–æ–≤
    ========================= */
    .grid::after{
      content:"";
      position:absolute; inset:0;
      border-radius:10px;
      pointer-events:none;
      opacity:0;
      background: radial-gradient(circle at 50% 45%, rgba(255,255,255,.55), rgba(255,255,255,0) 55%);
      transition: opacity .18s ease;
    }
    .grid.fx-flash::after{ opacity:1; }

    .cell.fx-hit{
      animation: fxHit .28s ease-out both;
      filter: drop-shadow(0 0 12px rgba(255,255,255,.55));
    }
    @keyframes fxHit{
      0%{ transform:scale(1); }
      45%{ transform:scale(1.13); }
      100%{ transform:scale(.98); }
    }

    .cell.fx-line{
      animation: fxLine .35s ease-out both;
      filter: drop-shadow(0 0 14px rgba(255,215,0,.85));
    }
    @keyframes fxLine{
      0%{ transform:scale(1); }
      40%{ transform:scale(1.18); }
      100%{ transform:scale(1); }
    }

    .cell.fx-bomb{
      animation: fxBomb .38s ease-out both;
      filter: drop-shadow(0 0 16px rgba(255,255,255,.75));
    }
    @keyframes fxBomb{
      0%{ transform:scale(1); }
      35%{ transform:scale(1.22) rotate(-2deg); }
      100%{ transform:scale(1) rotate(0deg); }
    }

    .grid.fx-shake{
      animation: fxShake .28s ease-out both;
    }
    @keyframes fxShake{
      0%{ transform:translateX(0); }
      25%{ transform:translateX(-5px); }
      50%{ transform:translateX(5px); }
      75%{ transform:translateX(-3px); }
      100%{ transform:translateX(0); }
    }

    .cell.fx-candle{
      animation: fxCandle .42s ease-out both;
      filter: drop-shadow(0 0 18px rgba(255,140,0,.85));
    }
    @keyframes fxCandle{
      0%{ transform:scale(1); }
      30%{ transform:scale(1.2); }
      60%{ transform:scale(1.08); }
      100%{ transform:scale(1); }
    }

    /* ---- –∞–¥–∞–ø—Ç–∏–≤ ---- */
    @media (max-width: 600px){
      :root{
        --cell: 43.75px;   /* 350/8 */
        --pad:  5px;
      }
      .cell{
        border-radius:14px;
        padding:0;
        background-size: 88% 88%;
      }
      h1{ font-size:24px; }
      .pill{ font-size:16px; }
    }
  </style>
</head>

<body>
  <h1>‚ùÑÔ∏è –®–ê–ì–ê–ô –î–û–ú–ê: –ó–∏–º–Ω—è—è –∏–≥—Ä–∞ ‚ùÑÔ∏è</h1>

  <div class="topbar">
    <div class="pill">–£—Ä–æ–≤–µ–Ω—å: <b id="level">1</b></div>
    <div class="pill">–¶–µ–ª—å: <b id="progress">0/0</b></div>
    <div class="pill">–•–æ–¥—ã: <b id="moves">0</b></div>
    <div class="pill">‚ö° –≠–Ω–µ—Ä–≥–∏—è: <b id="energy">0</b></div>
  </div>

  <div class="grid" id="grid"></div>

  <div class="btnbar">
    <button onclick="startGame()">üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
    <button onclick="showIntro()">üìú –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —É—Ä–æ–≤–Ω—è</button>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal">
      <h2 id="introTitle">–£—Ä–æ–≤–µ–Ω—å</h2>
      <p id="introText"></p>
      <ul id="introList"></ul>
      <div class="actions">
        <button id="introBtn">–ü–æ–Ω—è—Ç–Ω–æ, –∏–≥—Ä–∞—é!</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ "–ó–∞—Ä—è–¥–∫–∞ —ç–Ω–µ—Ä–≥–∏–∏" -->
  <div class="overlay" id="energyOverlay" aria-hidden="true">
    <div class="modal">
      <h2>‚ö° –ó–∞–∫–æ–Ω—á–∏–ª–∏—Å—å —Ö–æ–¥—ã?</h2>
      <p id="energyText">
        –í—Ä–µ–º—è –∑–∞—Ä—è–¥–∏—Ç—å –±–∞—Ç–∞—Ä–µ–π–∫—É! –°–¥–µ–ª–∞–π—Ç–µ 100 —à–∞–≥–æ–≤ –Ω–∞ –º–µ—Å—Ç–µ –∏–ª–∏ 15 –ø—Ä–∏—Å–µ–¥–∞–Ω–∏–π ‚Äî
        –∏ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –Ω–æ–≤–∞—è –∂–∏–∑–Ω—å.
      </p>

      <ul>
        <li><b>–í–∞—Ä–∏–∞–Ω—Ç 1:</b> 100 —à–∞–≥–æ–≤ –Ω–∞ –º–µ—Å—Ç–µ</li>
        <li><b>–í–∞—Ä–∏–∞–Ω—Ç 2:</b> 15 –ø—Ä–∏—Å–µ–¥–∞–Ω–∏–π</li>
      </ul>

      <div class="actions" style="margin-top:12px; display:flex; gap:10px;">
        <button id="energyStartBtn">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –∑–∞—Ä—è–¥–∫—É (30 —Å–µ–∫)</button>
        <button id="energyDoneBtn" disabled>‚úÖ –ì–æ—Ç–æ–≤–æ ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –∂–∏–∑–Ω—å</button>
      </div>

      <p style="margin-top:10px; opacity:.85;">
        –û—Å—Ç–∞–ª–æ—Å—å: <b id="energyTimer">30</b> —Å–µ–∫
      </p>
    </div>
  </div>

<script>
/* =========================================================================
   –ù–ê–°–¢–†–û–ô–ö–ê –ü–£–¢–ï–ô –ö –ö–ê–†–¢–ò–ù–ö–ê–ú
============================================================================ */
const ASSET_PATH = '/Camp/wintergame/';

const IMG = {
  // –æ–±—ã—á–Ω—ã–µ
  snowflake: ASSET_PATH + 'IMG_3660.png',
  thermos:   ASSET_PATH + 'IMG_3661.png',
  steps:     ASSET_PATH + 'IMG_3662.png',
  boots:     ASSET_PATH + 'IMG_3663.png',
  mittens:   ASSET_PATH + 'IMG_3664.png',
  tree:      ASSET_PATH + 'IMG_3659.png',

  // —Å–ø–µ—Ü
  goldSteps:     ASSET_PATH + 'IMG_3655.png',
  candle:        ASSET_PATH + 'IMG_3656.png',
  giftBag:       ASSET_PATH + 'IMG_3657.png',
  goldSnowflake: ASSET_PATH + 'IMG_3658.png',

  // –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
snowBlock: ASSET_PATH + 'IMG_snow.png',
ice3:      ASSET_PATH + 'IMG_ice_3.png',
ice2:      ASSET_PATH + 'IMG_ice_2.png',
ice1:      ASSET_PATH + 'IMG_ice_1.png',
  // —Ñ–æ–Ω/–ø–æ–¥–ª–æ–∂–∫–∞
  bg:    ASSET_PATH + 'IMG_3671.png',
  board: ASSET_PATH + 'IMG_3672.png',
};

  // ---- –ó–í–£–ö–ò ----
const SFX = {
  ice: new Audio(ASSET_PATH + 'ice.mp3'),
};

// –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–≤—É–∫–∞
SFX.ice.volume = 0.6;        // –≥—Ä–æ–º–∫–æ—Å—Ç—å (0‚Äì1)
SFX.ice.preload = 'auto';

const NORMAL_COLORS = ['snowflake','thermos','steps','boots','mittens','tree'];

// —Ç–∏–ø—ã —Å–ø–µ—Ü–æ–≤
const SPECIAL = {
  LINE:  'special_line',
  BOMB:  'special_bomb',
  CLEAR: 'special_clear',
  CANDLE:'special_candle',
};

// –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
const BLOCK = {
  SNOW: 'snow',
  ICE:  'ice',
};

// —É—Ä–æ–≤–Ω–∏
const LEVELS = [
  { id:1,  target: 60,  intro:"–£—Ä–æ–≤–µ–Ω—å 1 ‚Äî –±–µ–∑ —Å–ø–µ—Ü-—ç–ª–µ–º–µ–Ω—Ç–æ–≤. –ü—Ä–æ—Å—Ç–æ —Å–æ–±–∏—Ä–∞–π—Ç–µ 3 –≤ —Ä—è–¥.", specials:[], obstacles:[] },
  { id:2,  target: 80,  intro:"–£—Ä–æ–≤–µ–Ω—å 2 ‚Äî –ø–æ—è–≤–ª—è—é—Ç—Å—è ¬´–ó–æ–ª–æ—Ç—ã–µ —à–∞–≥–∏¬ª. –°–æ–±–µ—Ä–∏—Ç–µ 4 –≤ —Ä—è–¥ ‚Üí –ø–æ—è–≤–∏—Ç—Å—è —Å–ø–µ—Ü. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –µ–≥–æ —Å–ª–µ–¥—É—é—â–∏–º —Ö–æ–¥–æ–º (–ø–µ—Ä–µ–¥–≤–∏–Ω—å—Ç–µ) ‚Üí –æ—á–∏—Å—Ç–∏—Ç—Å—è —Å—Ç—Ä–æ–∫–∞.", specials:[SPECIAL.LINE], obstacles:[] },
  { id:3,  target: 95,  intro:"–£—Ä–æ–≤–µ–Ω—å 3 ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –º–µ—à–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤. –°–æ–±–µ—Ä–∏—Ç–µ L/T-–∫–æ–º–±–∏–Ω–∞—Ü–∏—é ‚Üí –ø–æ—è–≤–∏—Ç—Å—è –º–µ—à–æ–∫, –æ–Ω –≤–∑—Ä—ã–≤–∞–µ—Ç –æ–±–ª–∞—Å—Ç—å 3√ó3.", specials:[SPECIAL.LINE, SPECIAL.BOMB], obstacles:[] },
  { id:4,  target: 115, intro:"–£—Ä–æ–≤–µ–Ω—å 4 ‚Äî –∑–æ–ª–æ—Ç–∞—è —Å–Ω–µ–∂–∏–Ω–∫–∞. –°–æ–±–µ—Ä–∏—Ç–µ 5 –≤ —Ä—è–¥ ‚Üí –ø–æ—è–≤–∏—Ç—Å—è —Å–Ω–µ–∂–∏–Ω–∫–∞, –æ–Ω–∞ –æ—á–∏—â–∞–µ—Ç –≤–µ—Å—å —ç–∫—Ä–∞–Ω.", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[] },
  { id:5,  target: 135, intro:"–£—Ä–æ–≤–µ–Ω—å 5 ‚Äî –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ ¬´–°–Ω–µ–∂–Ω—ã–π —Å—É–≥—Ä–æ–±¬ª. –û–Ω –±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–ª–µ—Ç–∫—É –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ö–æ–¥–æ–≤.", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[BLOCK.SNOW] },

  { id:6,  target: 155, intro:"–£—Ä–æ–≤–µ–Ω—å 6 ‚Äî –±–æ–ª—å—à–µ —Å—É–≥—Ä–æ–±–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ø–µ—Ü-—ç–ª–µ–º–µ–Ω—Ç—ã, —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–∂–¥–∞—Ç—å –ø–æ–ª–µ.", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[BLOCK.SNOW] },
  { id:7,  target: 175, intro:"–£—Ä–æ–≤–µ–Ω—å 7 ‚Äî —Å—É–≥—Ä–æ–±—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —á–∞—â–µ. –î–µ–ª–∞–π—Ç–µ 4 –∏ 5 –≤ —Ä—è–¥ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—á–∏—Å—Ç–æ–∫.", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[BLOCK.SNOW] },
  { id:8,  target: 195, intro:"–£—Ä–æ–≤–µ–Ω—å 8 ‚Äî –¥–µ—Ä–∂–∏–º —Ç–µ–º–ø: –∫–∞—Å–∫–∞–¥—ã –ø–æ—Å–ª–µ –ø–∞–¥–µ–Ω–∏—è —Ñ–∏—à–µ–∫ –¥–∞—é—Ç –±–æ–ª—å—à–µ –º–∞—Ç—á–µ–π.", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[BLOCK.SNOW] },
  { id:9,  target: 215, intro:"–£—Ä–æ–≤–µ–Ω—å 9 ‚Äî –ø–æ—á—Ç–∏ —Ñ–∏–Ω–∞–ª –ø–µ—Ä–µ–¥ –ª—å–¥–æ–º. –ì–æ—Ç–æ–≤–∏–º—Å—è –∫ –∑–∞–º–æ—Ä–æ–∑–∫–µ!", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[BLOCK.SNOW] },

  { id:10, target: 240, intro:"–£—Ä–æ–≤–µ–Ω—å 10 ‚Äî –ø–æ—è–≤–ª—è–µ—Ç—Å—è ¬´–õ–µ–¥—è–Ω–∞—è –∫–ª–µ—Ç–∫–∞¬ª (3 —Å–ª–æ—è) –∏ ¬´–°–≤–µ—á–∫–∞¬ª. –°–≤–µ—á–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å–Ω–∏–º–∞–µ—Ç 1 —Å–ª–æ–π –ª—å–¥–∞ –≤ –æ–±–ª–∞—Å—Ç–∏ 3√ó3.", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR, SPECIAL.CANDLE], obstacles:[BLOCK.SNOW, BLOCK.ICE] },
];

const width = 8;

const grid = document.getElementById('grid');
const levelDisplay = document.getElementById('level');
const progressDisplay = document.getElementById('progress');

const movesDisplay  = document.getElementById('moves');
const energyDisplay = document.getElementById('energy');

const overlay = document.getElementById('overlay');
const introTitle = document.getElementById('introTitle');
const introText  = document.getElementById('introText');
const introList  = document.getElementById('introList');
const introBtn   = document.getElementById('introBtn');

// –∑–∞—Ä—è–¥–∫–∞
const energyOverlay  = document.getElementById('energyOverlay');
const energyStartBtn = document.getElementById('energyStartBtn');
const energyDoneBtn  = document.getElementById('energyDoneBtn');
const energyTimerEl  = document.getElementById('energyTimer');

let squares = [];
let score = 0;
let levelIndex = 0;

let selectedSquare = null;

let squareIdBeingDragged = null;
let squareIdBeingReplaced = null;

let isResolving = false;

// ===== –≠–ù–ï–†–ì–ò–Ø / –•–û–î–´ =====
const MOVES_PER_LIFE = 20;   // —Å–∫–æ–ª—å–∫–æ —Ö–æ–¥–æ–≤ –¥–∞—ë—Ç 1 "–∂–∏–∑–Ω—å"
let energy = 1;              // —Ç–µ–∫—É—â–∞—è —ç–Ω–µ—Ä–≥–∏—è (–∂–∏–∑–Ω–∏)
let movesLeft = MOVES_PER_LIFE;

let rechargeInterval = null;
let rechargeSeconds = 30;

/* =========================================================================
   –£–¢–ò–õ–ò–¢–´
============================================================================ */
function sleep(ms){ return new Promise(res=>setTimeout(res, ms)); }

function addFxToCells(indices, cls){
  indices.forEach(i=>{
    const el = squares[i];
    if(!el) return;
    el.classList.add(cls);
    setTimeout(()=>el.classList.remove(cls), 420);
  });
}

function flashGrid(shake=false){
  grid.classList.add('fx-flash');
  if(shake) grid.classList.add('fx-shake');
  setTimeout(()=>{
    grid.classList.remove('fx-flash');
    grid.classList.remove('fx-shake');
  }, 260);
}

/* =========================================================================
   –≠–ù–ï–†–ì–ò–Ø / –ó–ê–†–Ø–î–ö–ê
============================================================================ */
function lockGame(){ isResolving = true; }
function unlockGame(){ isResolving = false; }

function openEnergyModal(){
  lockGame();

  rechargeSeconds = 30;
  energyTimerEl.textContent = rechargeSeconds;
  energyDoneBtn.disabled = true;

  if(rechargeInterval){
    clearInterval(rechargeInterval);
    rechargeInterval = null;
  }

  energyOverlay.classList.add('show');
  energyOverlay.setAttribute('aria-hidden','false');
}

function closeEnergyModal(){
  energyOverlay.classList.remove('show');
  energyOverlay.setAttribute('aria-hidden','true');
  unlockGame();
}

function consumeMove(){
  movesLeft = Math.max(0, movesLeft - 1);
  setupHUD();
  if(movesLeft === 0) openEnergyModal();
}

energyStartBtn.onclick = () => {
  if(rechargeInterval) return;

  energyDoneBtn.disabled = true;
  rechargeSeconds = 30;
  energyTimerEl.textContent = rechargeSeconds;

  rechargeInterval = setInterval(()=>{
    rechargeSeconds--;
    energyTimerEl.textContent = rechargeSeconds;

    if(rechargeSeconds <= 0){
      clearInterval(rechargeInterval);
      rechargeInterval = null;
      energyDoneBtn.disabled = false;
    }
  }, 1000);
};

energyDoneBtn.onclick = () => {
  energy += 1;
  movesLeft = MOVES_PER_LIFE;
  setupHUD();
  closeEnergyModal();
};

// —Ñ–æ–Ω –º–æ–¥–∞–ª–∫–∏ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç (—á—Ç–æ–±—ã –Ω–µ–ª—å–∑—è –±—ã–ª–æ –æ–±–æ–π—Ç–∏ –∑–∞—Ä—è–¥–∫—É)
energyOverlay.addEventListener('click', (e)=>{
  if(e.target === energyOverlay){
    // –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
  }
});

/* =========================================================================
   –ú–û–î–ï–õ–¨ –ö–õ–ï–¢–ö–ò (dataset)
============================================================================ */
function currentLevel(){
  return LEVELS[levelIndex] || LEVELS[LEVELS.length-1];
}

function resolveImage(colorKey, type){
  if(!colorKey) return '';
  if(type === SPECIAL.LINE)   return IMG.goldSteps;
  if(type === SPECIAL.BOMB)   return IMG.giftBag;
  if(type === SPECIAL.CLEAR)  return IMG.goldSnowflake;
  if(type === SPECIAL.CANDLE) return IMG.candle;
  return IMG[colorKey] || '';
}
  function updateBlockVisual(i){
  const sq = squares[i];

  if(sq.dataset.block === BLOCK.SNOW){
    sq.style.backgroundImage = `url('${IMG.snowBlock}')`;
    return;
  }

  if(sq.dataset.block === BLOCK.ICE){
    const hp = sq.dataset.icehp;
    if(hp === '3') sq.style.backgroundImage = `url('${IMG.ice3}')`;
    if(hp === '2') sq.style.backgroundImage = `url('${IMG.ice2}')`;
    if(hp === '1') sq.style.backgroundImage = `url('${IMG.ice1}')`;
    return;
  }

  // –µ—Å–ª–∏ –±–ª–æ–∫ —Å–Ω—è—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ã—á–Ω—É—é —Ñ–∏—à–∫—É
  const img = resolveImage(sq.dataset.color, sq.dataset.type);
  sq.style.backgroundImage = img ? `url('${img}')` : '';
}

function setCell(square, colorKey, type='normal'){
  square.dataset.color = colorKey || '';
  square.dataset.type = type || 'normal';
  const img = resolveImage(square.dataset.color, square.dataset.type);
  square.style.backgroundImage = img ? `url('${img}')` : '';
}

function clearCell(i){
  const sq = squares[i];
  setCell(sq, '', 'normal');
}

function hasCandy(i){
  return squares[i].dataset.color !== '';
}

function randomNormal(){
  return NORMAL_COLORS[Math.floor(Math.random() * NORMAL_COLORS.length)];
}

function isBlocked(i){
  const sq = squares[i];
  return (sq.dataset.block === BLOCK.SNOW && (+sq.dataset.turns || 0) > 0)
      || (sq.dataset.block === BLOCK.ICE  && (+sq.dataset.icehp || 0) > 0);
}

/* =========================================================================
   HUD / –ò–ù–¢–†–û
============================================================================ */
function setupHUD(){
  const lvl = currentLevel();
  levelDisplay.textContent = lvl.id;

  // ‚úÖ ¬´–¶–µ–ª—å: 0/60¬ª
  progressDisplay.textContent = `${score}/${lvl.target}`;

  movesDisplay.textContent  = movesLeft;
  energyDisplay.textContent = energy;
}

function showIntro(){
  const lvl = currentLevel();
  introTitle.textContent = `–£—Ä–æ–≤–µ–Ω—å ${lvl.id}`;
  introText.textContent = lvl.intro;

  introList.innerHTML = '';
  const items = [];
  items.push('–°–æ–±–µ—Ä–∏—Ç–µ 3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Ñ–∏—à–∫–∏ –ø–æ–¥—Ä—è–¥ ‚Äî –æ–Ω–∏ –∏—Å—á–µ–∑–Ω—É—Ç, –∞ –Ω–æ–≤—ã–µ —É–ø–∞–¥—É—Ç —Å–≤–µ—Ä—Ö—É.');
  items.push('–ö–∞–∂–¥—ã–π —É—Å–ø–µ—à–Ω—ã–π —Ö–æ–¥ —Ç—Ä–∞—Ç–∏—Ç 1 —Ö–æ–¥. –ö–æ–≥–¥–∞ —Ö–æ–¥—ã –∑–∞–∫–æ–Ω—á–∞—Ç—Å—è ‚Äî –Ω—É–∂–Ω–æ ‚Äú–∑–∞—Ä—è–¥–∏—Ç—å—Å—è‚Äù, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—É—é –∂–∏–∑–Ω—å.');

  const s = lvl.specials;
  if(s.includes(SPECIAL.LINE))  items.push('4 –≤ —Ä—è–¥ ‚Üí ¬´–ó–æ–ª–æ—Ç—ã–µ —à–∞–≥–∏¬ª. –ü–µ—Ä–µ–¥–≤–∏–Ω—å—Ç–µ –∏—Ö —Å–ª–µ–¥—É—é—â–∏–º —Ö–æ–¥–æ–º ‚Üí –æ—á–∏—Å—Ç–∏—Ç—Å—è —Å—Ç—Ä–æ–∫–∞.');
  if(s.includes(SPECIAL.BOMB))  items.push('L/T-–∫–æ–º–±–∏–Ω–∞—Ü–∏—è ‚Üí ¬´–ú–µ—à–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤¬ª (–≤–∑—Ä—ã–≤ 3√ó3).');
  if(s.includes(SPECIAL.CLEAR)) items.push('5 –≤ —Ä—è–¥ ‚Üí ¬´–ó–æ–ª–æ—Ç–∞—è —Å–Ω–µ–∂–∏–Ω–∫–∞¬ª (–æ—á–∏—â–∞–µ—Ç –≤–µ—Å—å —ç–∫—Ä–∞–Ω).');
  if(lvl.obstacles.includes(BLOCK.SNOW)) items.push('–°—É–≥—Ä–æ–±—ã –±–ª–æ–∫–∏—Ä—É—é—Ç –∫–ª–µ—Ç–∫–∏ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ö–æ–¥–æ–≤ (–∏—Ö –Ω–µ–ª—å–∑—è –¥–≤–∏–≥–∞—Ç—å).');
  if(lvl.obstacles.includes(BLOCK.ICE))  items.push('–õ—ë–¥ (3 —Å–ª–æ—è) –ª–æ–º–∞–µ—Ç—Å—è –ø–æ 1 —Å–ª–æ—é –æ—Ç —ç—Ñ—Ñ–µ–∫—Ç–æ–≤. –°–≤–µ—á–∫–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞–∑–º–æ—Ä–∞–∂–∏–≤–∞—Ç—å –ª—ë–¥.');

  items.forEach(t=>{
    const li = document.createElement('li');
    li.textContent = t;
    introList.appendChild(li);
  });

  overlay.classList.add('show');
  overlay.setAttribute('aria-hidden','false');
}

introBtn.onclick = () => {
  overlay.classList.remove('show');
  overlay.setAttribute('aria-hidden','true');
};

overlay.addEventListener('click', (e)=>{
  if(e.target === overlay){
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden','true');
  }
});

/* =========================================================================
   –ü–†–ï–ü–Ø–¢–°–¢–í–ò–Ø
============================================================================ */
function placeObstacles(){
  const lvl = currentLevel();

  for(let i=0;i<squares.length;i++){
    squares[i].dataset.block = '';
    squares[i].dataset.turns = '';
    squares[i].dataset.icehp = '';
    squares[i].dataset.ice = '';
  }

  if(lvl.obstacles.includes(BLOCK.SNOW)){
    const count = Math.min(10, 3 + Math.floor((lvl.id-5)*1.2));
    dropSnow(count);
  }

  if(lvl.obstacles.includes(BLOCK.ICE)){
    dropIce(10);
  }
}

function dropSnow(count){
  let placed = 0;
  while(placed < count){
    const i = Math.floor(Math.random() * (width*width));
    if(i < width) continue;
    if(squares[i].dataset.block) continue;

    squares[i].dataset.block = BLOCK.SNOW;
    squares[i].dataset.turns = 3;

    updateBlockVisual(i);
    placed++;
  }
}

function dropIce(count){
  let placed = 0;
  while(placed < count){
    const i = Math.floor(Math.random() * (width*width));
    if(i < width) continue;
    if(squares[i].dataset.block) continue;

    squares[i].dataset.block = BLOCK.ICE;
    squares[i].dataset.icehp = '3';

    updateBlockVisual(i);
    placed++;
  }
}

function tickObstaclesAfterMove(){
  for(let i=0;i<squares.length;i++){
    const sq = squares[i];

    if(sq.dataset.block === BLOCK.SNOW){
      let t = +sq.dataset.turns;
      t--;
      sq.dataset.turns = t;

      if(t <= 0){
        sq.dataset.block = '';
        sq.dataset.turns = '';
        updateBlockVisual(i);
      }
    }
  }
}


function damageIceAt(i, amount=1){
  const sq = squares[i];
  if(sq.dataset.block !== BLOCK.ICE) return;

  let hp = +sq.dataset.icehp;
  hp = Math.max(0, hp - amount);
  sq.dataset.icehp = String(hp);

  // üîä –∑–≤—É–∫ —Ç—Ä–µ—Å–∫–∞ –ª—å–¥–∞
  playIceSound();

  if(hp === 0){
    sq.dataset.block = '';
    sq.dataset.icehp = '';
  }

  updateBlockVisual(i);
}

/* =========================================================================
   –°–û–ó–î–ê–ù–ò–ï –ü–û–õ–Ø
============================================================================ */
function createBoard(){
  grid.innerHTML = '';
  squares = [];

  for(let i=0;i<width*width;i++){
    const sq = document.createElement('div');
    sq.className = 'cell';
    sq.setAttribute('draggable', true);
    sq.setAttribute('id', i);

    sq.dataset.block = '';
    sq.dataset.turns = '';
    sq.dataset.icehp = '';
    sq.dataset.ice = '';

    setCell(sq, randomNormal(), 'normal');

    sq.addEventListener('click', selectSquare);

    sq.addEventListener('dragstart', dragStart);
    sq.addEventListener('dragover', (e)=>e.preventDefault());
    sq.addEventListener('dragenter', (e)=>e.preventDefault());
    sq.addEventListener('drop', dragDrop);
    sq.addEventListener('dragend', dragEnd);

    grid.appendChild(sq);
    squares.push(sq);
  }

  placeObstacles();
  stabilizeNoInitialMatches();
}

/* =========================================================================
   –í–´–ë–û–† / –ü–ï–†–ï–°–¢–ê–ù–û–í–ö–ê
============================================================================ */
function selectSquare(e){
  if(isResolving) return;

  const id = parseInt(e.currentTarget.id, 10);
  if(isBlocked(id)) return;

  if(selectedSquare === null){
    selectedSquare = id;
    squares[id].classList.add('selected');
    return;
  }

  if(selectedSquare === id){
    squares[selectedSquare].classList.remove('selected');
    selectedSquare = null;
    return;
  }

  const validMoves = [selectedSquare-1, selectedSquare+1, selectedSquare-width, selectedSquare+width];
  const isAdjacent = validMoves.includes(id);

  if(isAdjacent){
    if(selectedSquare % width === 0 && id === selectedSquare - 1) return;
    if(selectedSquare % width === width-1 && id === selectedSquare + 1) return;
    if(isBlocked(id)) return;

    squares[selectedSquare].classList.remove('selected');
    const from = selectedSquare;
    selectedSquare = null;

    doMove(from, id);
  } else {
    squares[selectedSquare].classList.remove('selected');
    selectedSquare = id;
    squares[id].classList.add('selected');
  }
}

function dragStart(){
  if(isResolving) return;
  const id = parseInt(this.id,10);
  if(isBlocked(id)) return;
  squareIdBeingDragged = this.id;
}

function dragDrop(){
  if(isResolving) return;
  const id = parseInt(this.id,10);
  if(isBlocked(id)) return;
  squareIdBeingReplaced = this.id;
}

function dragEnd(){
  if(isResolving) { squareIdBeingDragged=null; squareIdBeingReplaced=null; return; }
  if(squareIdBeingDragged === null || squareIdBeingReplaced === null) return;

  const from = parseInt(squareIdBeingDragged,10);
  const to   = parseInt(squareIdBeingReplaced,10);

  squareIdBeingDragged = null;
  squareIdBeingReplaced = null;

  if(isBlocked(from) || isBlocked(to)) return;

  const validMoves = [from-1, from+1, from-width, from+width];
  let validMove = validMoves.includes(to);

  if(from % width === 0 && to === from - 1) validMove = false;
  if(from % width === width-1 && to === from + 1) validMove = false;

  if(!validMove) return;

  doMove(from, to);
}

/* =========================================================================
   –•–û–î
============================================================================ */
function doSwap(a,b){
  const A = squares[a], B = squares[b];

  const tempColor = A.dataset.color;
  const tempType  = A.dataset.type;

  A.dataset.color = B.dataset.color;
  A.dataset.type  = B.dataset.type;
  B.dataset.color = tempColor;
  B.dataset.type  = tempType;

  A.style.backgroundImage = A.dataset.color ? `url('${resolveImage(A.dataset.color, A.dataset.type)}')` : '';
  B.style.backgroundImage = B.dataset.color ? `url('${resolveImage(B.dataset.color, B.dataset.type)}')` : '';
}

async function doMove(from,to){
  if(isResolving) return;
  isResolving = true;

  doSwap(from,to);
  tickObstaclesAfterMove();

  let activated = false;
  if(squares[to].dataset.type !== 'normal'){
    activated = await activateSpecialAt(to);
  } else if(squares[from].dataset.type !== 'normal'){
    activated = await activateSpecialAt(from);
  }

  if(activated){
    consumeMove();
    await resolveBoard();
    isResolving = false;
    checkLevelComplete();
    return;
  }

  const matches = findAllMatches();
  if(matches.length === 0){
    doSwap(from,to);
    isResolving = false;
    return;
  }

  consumeMove();
  await applyMatches(matches, {from, to});
  await resolveBoard();

  isResolving = false;
  checkLevelComplete();
}

/* =========================================================================
   –ê–ö–¢–ò–í–ê–¶–ò–Ø –°–ü–ï–¶-–≠–õ–ï–ú–ï–ù–¢–û–í
============================================================================ */
async function activateSpecialAt(i){
  const sq = squares[i];
  const type = sq.dataset.type;
  if(type === 'normal') return false;
  if(isBlocked(i)) return false;

  let affected = [];

  if(type === SPECIAL.LINE){
    const row = Math.floor(i / width);
    const start = row * width;
    for(let c=0;c<width;c++) affected.push(start + c);

    addFxToCells([i], 'fx-line');
    addFxToCells(affected, 'fx-hit');
    flashGrid(false);

    await sleep(160);

    for(const idx of affected){
      if(squares[idx].dataset.block === BLOCK.ICE) damageIceAt(idx, 1);
      if(!isBlocked(idx)) clearCell(idx);
    }
    clearCell(i);
    addScore(8);
    return true;
  }

  if(type === SPECIAL.BOMB){
    const r0 = Math.floor(i/width);
    const c0 = i % width;
    for(let dr=-1; dr<=1; dr++){
      for(let dc=-1; dc<=1; dc++){
        const r = r0 + dr, c = c0 + dc;
        if(r<0||r>=width||c<0||c>=width) continue;
        affected.push(r*width + c);
      }
    }

    addFxToCells([i], 'fx-bomb');
    addFxToCells(affected, 'fx-hit');
    flashGrid(false);

    await sleep(170);

    for(const idx of affected){
      if(squares[idx].dataset.block === BLOCK.ICE) damageIceAt(idx, 1);
      if(!isBlocked(idx)) clearCell(idx);
    }
    clearCell(i);
    addScore(10);
    return true;
  }

  if(type === SPECIAL.CLEAR){
    affected = Array.from({length: width*width}, (_,k)=>k);

    flashGrid(true);
    addFxToCells([i], 'fx-hit');

    for(let p=0; p<affected.length; p+=8){
      addFxToCells(affected.slice(p, p+8), 'fx-hit');
      await sleep(18);
    }

    for(let idx=0; idx<width*width; idx++){
      if(squares[idx].dataset.block === BLOCK.ICE) damageIceAt(idx, 1);
      if(!isBlocked(idx)) clearCell(idx);
    }
    addScore(16);
    return true;
  }

  if(type === SPECIAL.CANDLE){
    const r0 = Math.floor(i/width);
    const c0 = i % width;
    for(let dr=-1; dr<=1; dr++){
      for(let dc=-1; dc<=1; dc++){
        const r = r0 + dr, c = c0 + dc;
        if(r<0||r>=width||c<0||c>=width) continue;
        affected.push(r*width + c);
      }
    }

    addFxToCells([i], 'fx-candle');
    addFxToCells(affected, 'fx-hit');
    flashGrid(false);

    await sleep(170);

    for(const idx of affected){
      if(squares[idx].dataset.block === BLOCK.ICE) damageIceAt(idx, 1);
      if(!isBlocked(idx)) clearCell(idx);
    }
    clearCell(i);
    addScore(12);
    return true;
  }

  return false;
}

/* =========================================================================
   –ü–û–ò–°–ö –ú–ê–¢–ß–ï–ô
============================================================================ */
function findAllMatches(){
  const groups = [];

  // —Å—Ç—Ä–æ–∫–∏
  for(let r=0;r<width;r++){
    let c=0;
    while(c<width){
      const idx = r*width + c;
      const key = squares[idx].dataset.color;
      const type = squares[idx].dataset.type;

      if(!key || type !== 'normal' || isBlocked(idx)){
        c++;
        continue;
      }

      let run = [idx];
      let cc = c+1;
      while(cc<width){
        const j = r*width + cc;
        if(squares[j].dataset.color === key && squares[j].dataset.type === 'normal' && !isBlocked(j)){
          run.push(j);
          cc++;
        } else break;
      }

      if(run.length >= 3){
        groups.push({cells:run, kind:'row', len:run.length, colorKey:key});
      }
      c = cc;
    }
  }

  // –∫–æ–ª–æ–Ω–∫–∏
  for(let c=0;c<width;c++){
    let r=0;
    while(r<width){
      const idx = r*width + c;
      const key = squares[idx].dataset.color;
      const type = squares[idx].dataset.type;

      if(!key || type !== 'normal' || isBlocked(idx)){
        r++;
        continue;
      }

      let run = [idx];
      let rr = r+1;
      while(rr<width){
        const j = rr*width + c;
        if(squares[j].dataset.color === key && squares[j].dataset.type === 'normal' && !isBlocked(j)){
          run.push(j);
          rr++;
        } else break;
      }

      if(run.length >= 3){
        groups.push({cells:run, kind:'col', len:run.length, colorKey:key});
      }
      r = rr;
    }
  }

  // L/T
  const cellToGroups = new Map();
  groups.forEach((g, gi)=>{
    g.cells.forEach(i=>{
      if(!cellToGroups.has(i)) cellToGroups.set(i, []);
      cellToGroups.get(i).push(gi);
    });
  });

  const ltGroups = [];
  cellToGroups.forEach((giList, cell)=>{
    if(giList.length >= 2){
      const keys = new Set(giList.map(gi=>groups[gi].colorKey));
      if(keys.size === 1){
        const union = new Set();
        giList.forEach(gi => groups[gi].cells.forEach(x=>union.add(x)));
        ltGroups.push({cells:[...union], kind:'lt', len:union.size, colorKey:[...keys][0], pivot:cell});
      }
    }
  });

  if(ltGroups.length){
    const blockedGroupIdx = new Set();
    ltGroups.forEach(lt=>{
      groups.forEach((g, gi)=>{
        if(g.colorKey !== lt.colorKey) return;
        const inter = g.cells.some(x=>lt.cells.includes(x));
        if(inter) blockedGroupIdx.add(gi);
      });
    });
    const filtered = groups.filter((g,gi)=>!blockedGroupIdx.has(gi));
    return [...filtered, ...ltGroups];
  }

  return groups;
}

/* =========================================================================
   –°–ü–ê–í–ù –°–ü–ï–¶–û–í –ò –û–ß–ò–°–¢–ö–ê
============================================================================ */
function levelHasSpecial(type){
  return currentLevel().specials.includes(type);
}

function addScore(n){
  score += n;
  setupHUD(); // ‚úÖ —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º ¬´–¶–µ–ª—å: score/target¬ª
}

async function applyMatches(matches, moveInfo){
  const toClear = new Set();

  function chooseSpawnCell(group){
    const {from, to} = moveInfo || {};
    if(typeof to === 'number' && group.cells.includes(to)) return to;
    if(typeof from === 'number' && group.cells.includes(from)) return from;
    return group.cells[Math.floor(group.cells.length/2)];
  }

  const spawns = [];

  for(const g of matches){
    if(g.kind === 'lt'){
      if(levelHasSpecial(SPECIAL.BOMB)){
        spawns.push({ at: (g.pivot ?? chooseSpawnCell(g)), type: SPECIAL.BOMB });
      }
      g.cells.forEach(i=>toClear.add(i));
      continue;
    }

    if(g.len >= 5){
      if(levelHasSpecial(SPECIAL.CLEAR)){
        spawns.push({ at: chooseSpawnCell(g), type: SPECIAL.CLEAR });
      }
      g.cells.forEach(i=>toClear.add(i));
      continue;
    }

    if(g.len === 4){
      if(levelHasSpecial(SPECIAL.LINE)){
        const spawnAt = chooseSpawnCell(g);
        if(levelHasSpecial(SPECIAL.CANDLE) && g.colorKey === 'thermos'){
          spawns.push({ at: spawnAt, type: SPECIAL.CANDLE });
        } else {
          spawns.push({ at: spawnAt, type: SPECIAL.LINE });
        }
      }
      g.cells.forEach(i=>toClear.add(i));
      continue;
    }

    g.cells.forEach(i=>toClear.add(i));
  }

  const spawnCells = new Set(spawns.map(s=>s.at));
  const clearList = [...toClear].filter(i=>!spawnCells.has(i));

  clearList.forEach(i=>squares[i].classList.add('fade-out'));
  await sleep(220);

  for(const i of clearList){
    if(squares[i].dataset.block === BLOCK.ICE) damageIceAt(i, 1);
    if(!isBlocked(i)) clearCell(i);
    squares[i].classList.remove('fade-out');
  }

  for(const s of spawns){
    if(isBlocked(s.at)) continue;
    if(!squares[s.at].dataset.color) squares[s.at].dataset.color = randomNormal();
    squares[s.at].dataset.type = s.type;
    squares[s.at].style.backgroundImage = `url('${resolveImage(squares[s.at].dataset.color, squares[s.at].dataset.type)}')`;
  }

  addScore(clearList.length);
}

  function playIceSound(){
  try{
    SFX.ice.currentTime = 0;
    SFX.ice.play();
  }catch(e){
    // –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –±—Ä–∞—É–∑–µ—Ä–æ–º –¥–æ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–∫–∞ ‚Äî —ç—Ç–æ –æ–∫
  }
}
/* =========================================================================
   –ì–†–ê–í–ò–¢–ê–¶–ò–Ø + –ö–ê–°–ö–ê–î–´
============================================================================ */
function moveDown(){
  for(let i = width*width - 1; i >= 0; i--){
    if(isBlocked(i)) continue;

    const below = i + width;
    if(below >= width*width) continue;
    if(isBlocked(below)) continue;

    if(!hasCandy(below) && hasCandy(i)){
      squares[below].dataset.color = squares[i].dataset.color;
      squares[below].dataset.type  = squares[i].dataset.type;
      squares[below].style.backgroundImage = squares[i].style.backgroundImage;
      clearCell(i);
    }
  }
}

function generateNewCandies(){
  for(let i=0;i<width;i++){
    if(isBlocked(i)) continue;
    if(!hasCandy(i)){
      setCell(squares[i], randomNormal(), 'normal');
    }
  }
}

async function resolveBoard(){
  for(let step=0; step<25; step++){
    for(let k=0;k<10;k++){
      moveDown();
      generateNewCandies();
      await sleep(40);
    }

    const matches = findAllMatches();
    if(matches.length === 0) break;

    await applyMatches(matches, null);
    await sleep(90);
  }
}

/* =========================================================================
   –°–¢–ê–†–¢ / –ü–ï–†–ï–•–û–î –£–†–û–í–ù–Ø
============================================================================ */
function stabilizeNoInitialMatches(){
  for(let tries=0; tries<30; tries++){
    const matches = findAllMatches();
    if(matches.length === 0) return;

    matches.forEach(g=>{
      const pick = g.cells[Math.floor(Math.random()*g.cells.length)];
      if(!isBlocked(pick)){
        setCell(squares[pick], randomNormal(), 'normal');
      }
    });
  }
}

function checkLevelComplete(){
  const lvl = currentLevel();
  if(score >= lvl.target){
    if(levelIndex < LEVELS.length-1){
      levelIndex++;
      startLevel(true);
    } else {
      introTitle.textContent = '–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ —É—Ä–æ–≤–Ω–∏! üéâ';
      introText.textContent  = '–ú–æ–∂–Ω–æ –∏–≥—Ä–∞—Ç—å –¥–∞–ª—å—à–µ —Ä–∞–¥–∏ –æ—á–∫–æ–≤ –∏–ª–∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.';
      introList.innerHTML = '';
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden','false');
    }
  }
}

function startLevel(resetScore){
  if(resetScore) score = 0;
  setupHUD();
  createBoard();
  showIntro();
}

function startGame(){
  levelIndex = 0;
  score = 0;

  energy = 1;
  movesLeft = MOVES_PER_LIFE;

  startLevel(true);
}

/* =========================================================================
   –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
============================================================================ */
setupHUD();
startGame();
</script>
</body>
</html>
