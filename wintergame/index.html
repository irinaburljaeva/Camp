<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–®–ê–ì–ê–ô –î–û–ú–ê: –ó–∏–º–Ω—è—è –∏–≥—Ä–∞</title>

  <style>
/* =========================
   –ë–ê–ó–ê
========================= */
*{ box-sizing:border-box; }

body{
  font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
  background: url("/Camp/wintergame/IMG_3671.png") center/cover no-repeat fixed;

  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;

  min-height:100svh;
  margin:0;
  color:#fff;
  user-select:none;

  padding:
    max(8px, env(safe-area-inset-top))
    max(8px, env(safe-area-inset-right))
    max(8px, env(safe-area-inset-bottom))
    max(8px, env(safe-area-inset-left));
}

.topbar, .btnbar, h1 { 
  width: min(680px, 100%);
}

h1{
  margin:0 0 6px;
  text-align:center;
  text-shadow:2px 2px 4px rgba(0,0,0,.3);
  font-size:clamp(18px, 4.5vw, 28px);
  line-height:1.2;
}

    .coachWrap{
  margin-top: 10px;
  border-radius: 14px;
  overflow: hidden;
  background: rgba(0,0,0,.06);
  border: 1px solid rgba(0,0,0,.08);
}

.coachVideo{
  width: 100%;
  height: auto;
  display: block;
  aspect-ratio: 16 / 9;
  background: #000;
}

.coachHint{
  padding: 8px 10px;
  font-size: 14px;
  opacity: .85;
}

/* =========================
   –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨
========================= */
.topbar{
  display:flex;
  gap:8px;
  align-items:center;
  justify-content:center;
  flex-wrap:wrap;
  margin-bottom:8px;
}

.pill{
  background:rgba(255,255,255,.2);
  padding:6px 12px;
  border-radius:12px;
  font-size:clamp(14px, 3.5vw, 16px);
  box-shadow:0 4px 6px rgba(0,0,0,.1);
  display:flex;
  gap:6px;
  align-items:center;
  white-space:nowrap;
}

/* =========================
   –ù–ê–°–¢–†–û–ô–ö–ò –ü–û–õ–Ø (PNG 512√ó512, 8√ó8)
========================= */
:root{
  --cols: 8;
  --img: 512px;
  --line: 2px;
  
  /* —Ä–∞–∑–º–µ—Ä –ø–æ–ª—è —Å —É—á–µ—Ç–æ–º –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞ */
  --board: min(92vw, 520px, calc(100svh - 280px));
  
  --gap: calc(var(--board) * (var(--line) / var(--img)));
  --pad: var(--gap);
  --icon: 86%;
}

/* =========================
   GRID
========================= */
.grid{
  position:relative;
  overflow:hidden;

  width: var(--board);
  height: var(--board);
  aspect-ratio: 1 / 1;

  display:grid;
  grid-template-columns: repeat(var(--cols), minmax(0, 1fr));
  grid-template-rows: repeat(var(--cols), minmax(0, 1fr));

  gap: var(--gap);
  padding: var(--pad);

  background-image: url("/Camp/wintergame/IMG_3672.png");
  background-repeat: no-repeat;
  background-position: center;
  background-size: contain;
  
  border-radius:10px;
  flex-shrink: 1;
}

/* =========================
   –ö–õ–ï–¢–ö–ò
========================= */
.cell{
  width:100%;
  height:100%;
  
  /* ‚úÖ –ö–ª–µ—Ç–∫–∏ —Ç–æ–∂–µ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ */
  aspect-ratio: 1 / 1;

  display:flex;
  align-items:center;
  justify-content:center;

  cursor:pointer;
  position:relative;
  overflow:hidden;

  border-radius:12px;

  background-repeat:no-repeat;
  background-position:center;
  background-size: var(--icon) var(--icon);

  transition: transform .18s ease, filter .18s ease, background-color .18s ease;
}

.cell:hover{
  transform:scale(1.04);
  background-color:rgba(255,255,255,.08);
}

.selected{
  background-color:rgba(255,255,255,.28) !important;
  transform:scale(1.06) !important;
  outline:2px solid rgba(255,255,255,.45);
  outline-offset:-2px;
}

/* =========================
   –ê–ù–ò–ú–ê–¶–ò–ò
========================= */
.fade-out{ 
  animation:fadeOut .45s forwards; 
}

@keyframes fadeOut{ 
  to{ 
    opacity:0; 
    transform:scale(0); 
  } 
}

/* =========================
   –°–ü–ï–¶-–≠–õ–ï–ú–ï–ù–¢–´
========================= */
.cell[data-type="special_line"]{
  filter:drop-shadow(0 0 10px rgba(255,215,0,.55));
}

.cell[data-type="special_bomb"]{
  filter:drop-shadow(0 0 10px rgba(255,255,255,.35));
}

.cell[data-type="special_clear"]{
  filter:drop-shadow(0 0 12px rgba(255,215,0,.75));
}

.cell[data-type="special_candle"]{
  filter:drop-shadow(0 0 12px rgba(255,140,0,.65));
}

/* =========================
   –ü–†–ï–ü–Ø–¢–°–¢–í–ò–Ø
========================= */
.cell[data-block="snow"],
.cell[data-block="ice"]{
  cursor:not-allowed;
  filter:saturate(.9) brightness(.95);
}

/* =========================
   –ö–ù–û–ü–ö–ò –°–ù–ò–ó–£
========================= */
.btnbar{
  display:flex;
  gap:8px;
  margin-top:10px;
  flex-wrap:wrap;
  justify-content:center;
}

.btnbar button{
  padding:8px 16px;
  font-size:clamp(14px, 3.5vw, 16px);

  background: rgba(255,255,255,.22);
  color:#fff;
  border:1px solid rgba(255,255,255,.28);
  border-radius:14px;
  box-shadow:0 6px 16px rgba(0,0,0,.18);

  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);

  cursor:pointer;
  transition: transform .15s, background .2s, border-color .2s;
}

.btnbar button:hover{
  background: rgba(255,255,255,.30);
  border-color: rgba(255,255,255,.40);
  transform: translateY(-1px);
}

.btnbar button:active{
  transform: translateY(0) scale(.98);
}

/* =========================
   –ú–û–î–ê–õ–ö–ò
========================= */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);

  display:none;
  align-items:center;
  justify-content:center;

  padding:18px;
  z-index:50;
}

.overlay.show{ 
  display:flex; 
}

.modal{
  width:min(560px, 95vw);
  max-height:85vh;
  overflow-y:auto;
  
  background:rgba(255,255,255,.96);
  color:#1f2937;
  border-radius:18px;
  padding:18px 18px 14px;
  box-shadow:0 16px 48px rgba(0,0,0,.35);
}

.modal h2{ 
  margin:0 0 8px; 
  font-size:20px; 
}

.modal p{ 
  margin:0 0 10px; 
  line-height:1.45; 
}

.modal ul{ 
  margin:0 0 12px; 
  padding-left:18px; 
}

.modal li{ 
  margin:6px 0; 
}

.modal .actions{ 
  display:flex; 
  gap:10px; 
  margin-top:10px; 
}

.modal button{
  flex:1;
  margin:0;
  padding:10px 14px;
  font-size:16px;
  background:#ff6b6b;
  color:#fff;
  border:none;
  border-radius:14px;
  cursor:pointer;
  box-shadow:0 6px 18px rgba(0,0,0,.18);
  transition:background .2s, transform .15s;
}

.modal button:hover{ 
  background:#ff4757; 
  transform:translateY(-1px); 
}

.modal button:active{
  transform:translateY(0);
}

.modal button:disabled{
  opacity:.5;
  cursor:not-allowed;
  transform:none !important;
  box-shadow:none;
}

/* =========================
   FX: –≤—Å–ø—ã—à–∫–∞ –ø–æ –ø–æ–ª—é
========================= */
.grid::after{
  content:"";
  position:absolute;
  inset:0;
  border-radius:10px;
  pointer-events:none;
  opacity:0;

  background: radial-gradient(circle at 50% 45%,
    rgba(255,255,255,.55),
    rgba(255,255,255,0) 55%
  );

  transition: opacity .18s ease;
}

.grid.fx-flash::after{ 
  opacity:1; 
}

.grid.fx-shake{ 
  animation: fxShake .28s ease-out both; 
}

@keyframes fxShake{
  0%{ transform:translateX(0); }
  25%{ transform:translateX(-5px); }
  50%{ transform:translateX(5px); }
  75%{ transform:translateX(-3px); }
  100%{ transform:translateX(0); }
}

/* =========================
   –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ –î–õ–Ø –ú–ê–õ–ï–ù–¨–ö–ò–• –≠–ö–†–ê–ù–û–í
========================= */
@media (max-height: 750px) {
  :root {
    --board: min(88vw, 480px, calc(100svh - 240px));
  }
  
  h1 {
    font-size:clamp(16px, 4vw, 22px);
    margin-bottom:4px;
  }
  
  .topbar {
    gap:6px;
    margin-bottom:6px;
  }
  
  .pill {
    font-size:clamp(13px, 3vw, 15px);
    padding:5px 10px;
  }
  
  .btnbar {
    margin-top:8px;
    gap:6px;
  }
  
  .btnbar button {
    padding:7px 14px;
    font-size:clamp(13px, 3vw, 15px);
  }
}

@media (max-height: 650px) {
  :root {
    --board: min(85vw, 420px, calc(100svh - 200px));
  }
  
  body {
    padding: max(4px, env(safe-area-inset-top)) max(4px, env(safe-area-inset-right)) max(4px, env(safe-area-inset-bottom)) max(4px, env(safe-area-inset-left));
  }
  
  h1 {
    font-size:clamp(14px, 3.5vw, 18px);
    margin-bottom:3px;
  }
}
 </style>
</head>

<body>
  <h1> –ó–∏–º–Ω—è—è –∏–≥—Ä–∞ –æ—Ç –®–ê–ì–ê–ô –î–û–ú–ê  </h1>

  <div class="topbar">
    <div class="pill">–£—Ä–æ–≤–µ–Ω—å: <b id="level">1</b></div>
    <div class="pill">–¶–µ–ª—å: <b id="progress">0/0</b></div>
    <div class="pill">–•–æ–¥—ã: <b id="moves">0</b></div>
  </div>

  <div class="grid" id="grid"></div>

  <div class="btnbar">
    <button onclick="startGame()">üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
    <button onclick="showIntro()">üìú –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —É—Ä–æ–≤–Ω—è</button>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal">
      <h2 id="introTitle">–£—Ä–æ–≤–µ–Ω—å</h2>
      <p id="introText"></p>
      <ul id="introList"></ul>
      <div class="actions">
        <button id="introBtn">–ü–æ–Ω—è—Ç–Ω–æ, –∏–≥—Ä–∞—é!</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ "–ó–∞—Ä—è–¥–∫–∞ —ç–Ω–µ—Ä–≥–∏–∏" -->
  <div class="overlay" id="energyOverlay" aria-hidden="true">
    <div class="modal">
      <h2>‚ö° –ó–∞–∫–æ–Ω—á–∏–ª–∏—Å—å —Ö–æ–¥—ã?</h2>
      <p id="energyText">
        –í—Ä–µ–º—è –∑–∞—Ä—è–¥–∏—Ç—å –±–∞—Ç–∞—Ä–µ–π–∫—É! –ü–æ—à–∞–≥–∞–π—Ç–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥ ‚Äî
        –∏ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –Ω–æ–≤–∞—è –∂–∏–∑–Ω—å.
      </p>
        <div class="coachWrap" aria-hidden="true">
    <video
      id="coachVideo"
      class="coachVideo"
      playsinline
      muted
      loop
      preload="metadata"
      poster="/Camp/wintergame/coach_poster.jpg"
    >
      <source src="/Camp/wintergame/coach.mp4" type="video/mp4" />
    </video>

    <div class="coachHint" id="coachHint">
      –ù–∞–∂–º–∏—Ç–µ ¬´–ù–∞—á–∞—Ç—å —à–∞–≥–∞—Ç—å¬ª, –∏ –≤–∏–¥–µ–æ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è üé¨
    </div>
  </div>

           <div class="actions" style="margin-top:12px; display:flex; gap:10px;">
        <button id="energyStartBtn">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å —à–∞–≥–∞—Ç—å (30 —Å–µ–∫)</button>
        <button id="energyDoneBtn" disabled>‚úÖ –ì–æ—Ç–æ–≤–æ ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –∂–∏–∑–Ω—å</button>
      </div>

      <p style="margin-top:10px; opacity:.85;">
        –û—Å—Ç–∞–ª–æ—Å—å: <b id="energyTimer">30</b> —Å–µ–∫
      </p>
    </div>
  </div>

<script>
/* =========================================================================
   –ù–ê–°–¢–†–û–ô–ö–ê –ü–£–¢–ï–ô –ö –ö–ê–†–¢–ò–ù–ö–ê–ú
============================================================================ */
const ASSET_PATH = '/Camp/wintergame/';

const IMG = {
  // –æ–±—ã—á–Ω—ã–µ
  snowflake: ASSET_PATH + 'IMG_3660.png',
  thermos:   ASSET_PATH + 'IMG_3661.png',
  steps:     ASSET_PATH + 'IMG_3662.png',
  boots:     ASSET_PATH + 'IMG_3663.png',
  mittens:   ASSET_PATH + 'IMG_3664.png',
  tree:      ASSET_PATH + 'IMG_3659.png',

  // —Å–ø–µ—Ü
  goldSteps:     ASSET_PATH + 'IMG_3655.png',
  candle:        ASSET_PATH + 'IMG_3656.png',
  giftBag:       ASSET_PATH + 'IMG_3657.png',
  goldSnowflake: ASSET_PATH + 'IMG_3658.png',

  // –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
snowBlock: ASSET_PATH + 'IMG_snow.png',
ice3:      ASSET_PATH + 'IMG_ice_3.png',
ice2:      ASSET_PATH + 'IMG_ice_2.png',
ice1:      ASSET_PATH + 'IMG_ice_1.png',
  // —Ñ–æ–Ω/–ø–æ–¥–ª–æ–∂–∫–∞
  bg:    ASSET_PATH + 'IMG_3671.png',
  board: ASSET_PATH + 'IMG_3672.png',
};

  // ---- –ó–í–£–ö–ò ----
const SFX = {
  ice: new Audio(ASSET_PATH + 'ice.mp3'),
};

// –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–≤—É–∫–∞
SFX.ice.volume = 0.6;        // –≥—Ä–æ–º–∫–æ—Å—Ç—å (0‚Äì1)
SFX.ice.preload = 'auto';

const NORMAL_COLORS = ['snowflake','thermos','steps','boots','mittens','tree'];

// —Ç–∏–ø—ã —Å–ø–µ—Ü–æ–≤
const SPECIAL = {
  LINE:  'special_line',
  BOMB:  'special_bomb',
  CLEAR: 'special_clear',
  CANDLE:'special_candle',
};

// –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
const BLOCK = {
  SNOW: 'snow',
  ICE:  'ice',
};

// —É—Ä–æ–≤–Ω–∏
const LEVELS = [
  { id:1,  target: 60,  intro:"–£—Ä–æ–≤–µ–Ω—å 1: —Å–æ–±–µ—Ä–∏—Ç–µ 3 –≤ —Ä—è–¥.", specials:[], obstacles:[] },
  { id:2,  target: 80,  intro:"–£—Ä–æ–≤–µ–Ω—å 2: —Å–æ–±–µ—Ä–∏—Ç–µ 4 –≤ —Ä—è–¥, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∑–æ–ª–æ—Ç—ã–µ —à–∞–≥–∏", specials:[SPECIAL.LINE], obstacles:[] },
  { id:3,  target: 95,  intro:"–£—Ä–æ–≤–µ–Ω—å 3: —Å–æ–±–µ—Ä–∏—Ç–µ L/T-–∫–æ–º–±–∏–Ω–∞—Ü–∏—é, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –º–µ—à–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤", specials:[SPECIAL.LINE, SPECIAL.BOMB], obstacles:[] },
  { id:4,  target: 115, intro:"–£—Ä–æ–≤–µ–Ω—å 4: —Å–æ–±–µ—Ä–∏—Ç–µ 5 –≤ —Ä—è–¥, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∑–æ–ª–æ—Ç—É—é —Å–Ω–µ–∂–∏–Ω–∫—É", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[] },
  { id:5,  target: 135, intro:"–£—Ä–æ–≤–µ–Ω—å 5: –ø–µ—Ä–≤–æ–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[BLOCK.SNOW] },

  { id:6,  target: 155, intro:"–£—Ä–æ–≤–µ–Ω—å 6: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ø–µ—Ü-—ç–ª–µ–º–µ–Ω—Ç—ã, —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –ø–æ–ª–µ", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[BLOCK.SNOW] },
  { id:7,  target: 175, intro:"–£—Ä–æ–≤–µ–Ω—å 7: —Å—É–≥—Ä–æ–±—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —á–∞—â–µ. –ë–µ–∑ —Å–ø–µ—Ü—ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ç—É—Ç –Ω–µ —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[BLOCK.SNOW] },
  { id:8,  target: 195, intro:"–£—Ä–æ–≤–µ–Ω—å 8: –¥–µ—Ä–∂–∏–º —Ç–µ–º–ø", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[BLOCK.SNOW] },
  { id:9,  target: 215, intro:"–£—Ä–æ–≤–µ–Ω—å 9: –ì–æ–≤–æ—Ä—è—Ç, —Å–∫–æ—Ä–æ –ø–æ–≥–æ–¥–∞ —Å—Ç–∞–Ω–µ—Ç –µ—â–µ —Ö–æ–ª–æ–¥–Ω–µ–µ!", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[BLOCK.SNOW] },

  { id:10, target: 240, intro:"–£—Ä–æ–≤–µ–Ω—å 10: —Ö–æ–ª–æ–¥–∞! –ü–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–µ–ø—è—Ç—Å–≤–∏–µ ¬´–ª–µ–¥—è–Ω–∞—è –∫–ª–µ—Ç–∫–∞¬ª –∏ ¬´–°–≤–µ—á–∫–∞¬ª", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR, SPECIAL.CANDLE], obstacles:[BLOCK.SNOW, BLOCK.ICE] },
];

const width = 8;

const grid = document.getElementById('grid');
const levelDisplay = document.getElementById('level');
const progressDisplay = document.getElementById('progress');

const movesDisplay  = document.getElementById('moves');

const overlay = document.getElementById('overlay');
const introTitle = document.getElementById('introTitle');
const introText  = document.getElementById('introText');
const introList  = document.getElementById('introList');
const introBtn   = document.getElementById('introBtn');

// –∑–∞—Ä—è–¥–∫–∞
const energyOverlay  = document.getElementById('energyOverlay');
const energyStartBtn = document.getElementById('energyStartBtn');
const energyDoneBtn  = document.getElementById('energyDoneBtn');
const energyTimerEl  = document.getElementById('energyTimer');
const coachVideo = document.getElementById('coachVideo');
const coachHint  = document.getElementById('coachHint');

let squares = [];
let score = 0;
let levelIndex = 0;
  let BombActivated = false;
  let SnowflakeActivated = false;

let selectedSquare = null;

let squareIdBeingDragged = null;
let squareIdBeingReplaced = null;

let isResolving = false;

// ===== –≠–ù–ï–†–ì–ò–Ø / –•–û–î–´ =====
const MOVES_PER_LIFE = 20;   // —Å–∫–æ–ª—å–∫–æ —Ö–æ–¥–æ–≤ –¥–∞—ë—Ç 1 "–∂–∏–∑–Ω—å"
let energy = 1;              // —Ç–µ–∫—É—â–∞—è —ç–Ω–µ—Ä–≥–∏—è (–∂–∏–∑–Ω–∏)
let movesLeft = MOVES_PER_LIFE;

let rechargeInterval = null;
let rechargeSeconds = 30;

  /* =========================================================================
   SAVE / LOAD (localStorage)
============================================================================ */
const SAVE_KEY = 'wintergame_progress_v1';

function saveProgress(){
  try{
    const data = {
      levelIndex,
      score,
      movesLeft,
      energy,
      BombActivated,
      SnowflakeActivated
    };
    localStorage.setItem(SAVE_KEY, JSON.stringify(data));
  }catch(e){}
}

function loadProgress(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw) return false;
    const data = JSON.parse(raw);

    levelIndex = Math.max(0, Math.min(LEVELS.length-1, +data.levelIndex || 0));
    score = +data.score || 0;
    movesLeft = +data.movesLeft || MOVES_PER_LIFE;
    energy = +data.energy || 1;

    BombActivated = !!data.BombActivated;
    SnowflakeActivated = !!data.SnowflakeActivated;
    saveProgress();
    return true;
  }catch(e){
    return false;
  }
}

function clearProgress(){
  try{ localStorage.removeItem(SAVE_KEY); }catch(e){}
}
/* =========================================================================
   –£–¢–ò–õ–ò–¢–´
============================================================================ */
function sleep(ms){ return new Promise(res=>setTimeout(res, ms)); }

function addFxToCells(indices, cls){
  indices.forEach(i=>{
    const el = squares[i];
    if(!el) return;
    el.classList.add(cls);
    setTimeout(()=>el.classList.remove(cls), 420);
  });
}

function flashGrid(shake=false){
  grid.classList.add('fx-flash');
  if(shake) grid.classList.add('fx-shake');
  setTimeout(()=>{
    grid.classList.remove('fx-flash');
    grid.classList.remove('fx-shake');
  }, 260);
}

/* =========================================================================
   –≠–ù–ï–†–ì–ò–Ø / –ó–ê–†–Ø–î–ö–ê
============================================================================ */
function lockGame(){ isResolving = true; }
function unlockGame(){ isResolving = false; }

function openEnergyModal(){
  lockGame();

  rechargeSeconds = 30;
  energyTimerEl.textContent = rechargeSeconds;
  energyDoneBtn.disabled = true;

  if(rechargeInterval){
    clearInterval(rechargeInterval);
    rechargeInterval = null;
  }

  energyOverlay.classList.add('show');
  energyOverlay.setAttribute('aria-hidden','false');

  // –≤–∏–¥–µ–æ –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  if(coachVideo){
    coachVideo.pause();
    coachVideo.currentTime = 0;
  }
  if(coachHint) coachHint.style.display = 'block';
}

function consumeMove(){
  movesLeft = Math.max(0, movesLeft - 1);
  setupHUD();
  saveProgress();
  if(movesLeft === 0) openEnergyModal();
}

energyStartBtn.onclick = () => {
  if(rechargeInterval) return;
    // —Å—Ç–∞—Ä—Ç—É–µ–º –≤–∏–¥–µ–æ (–ø–æ—Å–ª–µ –∫–ª–∏–∫–∞ ‚Äî –∞–≤—Ç–æ–ø–ª–µ–π —Ä–∞–∑—Ä–µ—à—ë–Ω –±—Ä–∞—É–∑–µ—Ä–æ–º)
  if(coachVideo){
    coachVideo.muted = true;     // –≤–∞–∂–Ω–æ –¥–ª—è iOS
    coachVideo.playsInline = true;
    coachVideo.play().catch(()=>{});
  }
  if(coachHint) coachHint.style.display = 'none';

  energyDoneBtn.disabled = true;
  rechargeSeconds = 30;
  energyTimerEl.textContent = rechargeSeconds;

  rechargeInterval = setInterval(()=>{
    rechargeSeconds--;
    energyTimerEl.textContent = rechargeSeconds;

    if(rechargeSeconds <= 0){
      clearInterval(rechargeInterval);
      rechargeInterval = null;
            if(coachVideo){
        coachVideo.pause();
      }
      energyDoneBtn.disabled = false;
    }
  }, 1000);
};

function closeEnergyModal(){
  energyOverlay.classList.remove('show');
  energyOverlay.setAttribute('aria-hidden','true');

  if(coachVideo){
    coachVideo.pause();
    coachVideo.currentTime = 0;
  }

  unlockGame();
}

/* =========================================================================
   –ú–û–î–ï–õ–¨ –ö–õ–ï–¢–ö–ò (dataset)
============================================================================ */
function currentLevel(){
  return LEVELS[levelIndex] || LEVELS[LEVELS.length-1];
}

function resolveImage(colorKey, type){
  if(!colorKey) return '';
  if(type === SPECIAL.LINE)   return IMG.goldSteps;
  if(type === SPECIAL.BOMB)   return IMG.giftBag;
  if(type === SPECIAL.CLEAR)  return IMG.goldSnowflake;
  if(type === SPECIAL.CANDLE) return IMG.candle;
  return IMG[colorKey] || '';
}
  function updateBlockVisual(i){
  const sq = squares[i];

  if(sq.dataset.block === BLOCK.SNOW){
    sq.style.backgroundImage = `url('${IMG.snowBlock}')`;
    return;
  }

  if(sq.dataset.block === BLOCK.ICE){
    const hp = sq.dataset.icehp;
    if(hp === '3') sq.style.backgroundImage = `url('${IMG.ice3}')`;
    if(hp === '2') sq.style.backgroundImage = `url('${IMG.ice2}')`;
    if(hp === '1') sq.style.backgroundImage = `url('${IMG.ice1}')`;
    return;
  }

  // –µ—Å–ª–∏ –±–ª–æ–∫ —Å–Ω—è—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ã—á–Ω—É—é —Ñ–∏—à–∫—É
  const img = resolveImage(sq.dataset.color, sq.dataset.type);
  sq.style.backgroundImage = img ? `url('${img}')` : '';
}

function setCell(square, colorKey, type='normal'){
  square.dataset.color = colorKey || '';
  square.dataset.type = type || 'normal';
  const img = resolveImage(square.dataset.color, square.dataset.type);
  square.style.backgroundImage = img ? `url('${img}')` : '';
}

function clearCell(i){
  const sq = squares[i];
  setCell(sq, '', 'normal');
}

function hasCandy(i){
  return squares[i].dataset.color !== '';
}

function randomNormal(){
  return NORMAL_COLORS[Math.floor(Math.random() * NORMAL_COLORS.length)];
}

function isBlocked(i){
  const sq = squares[i];
  return (sq.dataset.block === BLOCK.SNOW && (+sq.dataset.turns || 0) > 0)
      || (sq.dataset.block === BLOCK.ICE  && (+sq.dataset.icehp || 0) > 0);
}

/* =========================================================================
   HUD / –ò–ù–¢–†–û
============================================================================ */
function setupHUD(){
  const lvl = currentLevel();
  levelDisplay.textContent = lvl.id;

  // ‚úÖ ¬´–¶–µ–ª—å: 0/60¬ª
  progressDisplay.textContent = `${score}/${lvl.target}`;

  movesDisplay.textContent  = movesLeft;

}

function showIntro(){
  const lvl = currentLevel();
  introTitle.textContent = `–£—Ä–æ–≤–µ–Ω—å ${lvl.id}`;
  introText.textContent = lvl.intro;

  introList.innerHTML = '';
  const items = [];
  items.push('–°–æ–±–µ—Ä–∏—Ç–µ 3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Ñ–∏—à–∫–∏ –ø–æ–¥—Ä—è–¥ ‚Äî –æ–Ω–∏ –∏—Å—á–µ–∑–Ω—É—Ç, –∞ –Ω–æ–≤—ã–µ —É–ø–∞–¥—É—Ç —Å–≤–µ—Ä—Ö—É.');
  items.push('–ö–∞–∂–¥–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Ñ–∏—à–µ–∫ —Ç—Ä–∞—Ç–∏—Ç 1 —Ö–æ–¥. –ö–æ–≥–¥–∞ —Ö–æ–¥—ã –∑–∞–∫–æ–Ω—á–∞—Ç—Å—è ‚Äî –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è ‚Äú–∑–∞—Ä—è–¥–∏—Ç—å—Å—è‚Äù, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—É—é –∂–∏–∑–Ω—å.');

  const s = lvl.specials;
  if(s.includes(SPECIAL.LINE))  items.push('4 –≤ —Ä—è–¥ ‚Üí ¬´–ó–æ–ª–æ—Ç—ã–µ —à–∞–≥–∏¬ª. –ü–µ—Ä–µ–¥–≤–∏–Ω—å—Ç–µ –∏—Ö —Å–ª–µ–¥—É—é—â–∏–º —Ö–æ–¥–æ–º ‚Üí –æ—á–∏—Å—Ç–∏—Ç—Å—è —Å—Ç—Ä–æ–∫–∞.');
  if(s.includes(SPECIAL.BOMB))  items.push('L/T-–∫–æ–º–±–∏–Ω–∞—Ü–∏—è ‚Üí ¬´–ú–µ—à–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤¬ª (–≤–∑—Ä—ã–≤ 3√ó3).');
  if(s.includes(SPECIAL.CLEAR)) items.push('5 –≤ —Ä—è–¥ ‚Üí ¬´–ó–æ–ª–æ—Ç–∞—è —Å–Ω–µ–∂–∏–Ω–∫–∞¬ª (–æ—á–∏—â–∞–µ—Ç –≤–µ—Å—å —ç–∫—Ä–∞–Ω).');
  if(lvl.obstacles.includes(BLOCK.SNOW)) items.push('–°—É–≥—Ä–æ–±—ã –±–ª–æ–∫–∏—Ä—É—é—Ç –∫–ª–µ—Ç–∫–∏ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ö–æ–¥–æ–≤ (–∏—Ö –Ω–µ–ª—å–∑—è –¥–≤–∏–≥–∞—Ç—å).');
  if(lvl.obstacles.includes(BLOCK.ICE))  items.push('–õ—ë–¥ (3 —Å–ª–æ—è) –ª–æ–º–∞–µ—Ç—Å—è –ø–æ 1 —Å–ª–æ—é –æ—Ç —ç—Ñ—Ñ–µ–∫—Ç–æ–≤. –°–≤–µ—á–∫–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞–∑–º–æ—Ä–∞–∂–∏–≤–∞—Ç—å –ª—ë–¥.');

  items.forEach(t=>{
    const li = document.createElement('li');
    li.textContent = t;
    introList.appendChild(li);
  });

  overlay.classList.add('show');
  overlay.setAttribute('aria-hidden','false');
}

introBtn.onclick = () => {
  overlay.classList.remove('show');
  overlay.setAttribute('aria-hidden','true');
};

overlay.addEventListener('click', (e)=>{
  if(e.target === overlay){
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden','true');
  }
});

/* =========================================================================
   –ü–†–ï–ü–Ø–¢–°–¢–í–ò–Ø
============================================================================ */
function placeObstacles(){
  const lvl = currentLevel();

  for(let i=0;i<squares.length;i++){
    squares[i].dataset.block = '';
    squares[i].dataset.turns = '';
    squares[i].dataset.icehp = '';
    squares[i].dataset.ice = '';
  }

  if(lvl.obstacles.includes(BLOCK.SNOW)){
    const count = Math.min(10, 3 + Math.floor((lvl.id-5)*1.2));
    dropSnow(count);
  }

  if(lvl.obstacles.includes(BLOCK.ICE)){
    dropIce(10);
  }
}

function dropSnow(count){
  let placed = 0;
  while(placed < count){
    const i = Math.floor(Math.random() * (width*width));
    if(i < width) continue;
    if(squares[i].dataset.block) continue;

    squares[i].dataset.block = BLOCK.SNOW;
    squares[i].dataset.turns = 3;

    updateBlockVisual(i);
    placed++;
  }
}

function dropIce(count){
  let placed = 0;
  while(placed < count){
    const i = Math.floor(Math.random() * (width*width));
    if(i < width) continue;
    if(squares[i].dataset.block) continue;

    squares[i].dataset.block = BLOCK.ICE;
    squares[i].dataset.icehp = '3';

    updateBlockVisual(i);
    placed++;
  }
}

function tickObstaclesAfterMove(){
  for(let i=0;i<squares.length;i++){
    const sq = squares[i];

    if(sq.dataset.block === BLOCK.SNOW){
      let t = +sq.dataset.turns;
      t--;
      sq.dataset.turns = t;

      if(t <= 0){
        sq.dataset.block = '';
        sq.dataset.turns = '';
        updateBlockVisual(i);
      }
    }
  }
}


function damageIceAt(i, amount=1){
  const sq = squares[i];
  if(sq.dataset.block !== BLOCK.ICE) return;

  let hp = +sq.dataset.icehp;
  hp = Math.max(0, hp - amount);
  sq.dataset.icehp = String(hp);

  // üîä –∑–≤—É–∫ —Ç—Ä–µ—Å–∫–∞ –ª—å–¥–∞
  playIceSound();

  if(hp === 0){
    sq.dataset.block = '';
    sq.dataset.icehp = '';
  }

  updateBlockVisual(i);
}

/* =========================================================================
   –°–û–ó–î–ê–ù–ò–ï –ü–û–õ–Ø
============================================================================ */
function createBoard(){
  grid.innerHTML = '';
  squares = [];

  for(let i=0;i<width*width;i++){
    const sq = document.createElement('div');
    sq.className = 'cell';
    sq.setAttribute('draggable', true);
    sq.setAttribute('id', i);

    sq.dataset.block = '';
    sq.dataset.turns = '';
    sq.dataset.icehp = '';
    sq.dataset.ice = '';

    setCell(sq, randomNormal(), 'normal');

    sq.addEventListener('click', selectSquare);

    sq.addEventListener('dragstart', dragStart);
    sq.addEventListener('dragover', (e)=>e.preventDefault());
    sq.addEventListener('dragenter', (e)=>e.preventDefault());
    sq.addEventListener('drop', dragDrop);
    sq.addEventListener('dragend', dragEnd);

    grid.appendChild(sq);
    squares.push(sq);
  }

  placeObstacles();
  stabilizeNoInitialMatches();
}

/* =========================================================================
   –í–´–ë–û–† / –ü–ï–†–ï–°–¢–ê–ù–û–í–ö–ê
============================================================================ */
function selectSquare(e){
  if(isResolving) return;

  const id = parseInt(e.currentTarget.id, 10);
  if(isBlocked(id)) return;

  if(selectedSquare === null){
    selectedSquare = id;
    squares[id].classList.add('selected');
    return;
  }

  if(selectedSquare === id){
    squares[selectedSquare].classList.remove('selected');
    selectedSquare = null;
    return;
  }

  const validMoves = [selectedSquare-1, selectedSquare+1, selectedSquare-width, selectedSquare+width];
  const isAdjacent = validMoves.includes(id);

  if(isAdjacent){
    if(selectedSquare % width === 0 && id === selectedSquare - 1) return;
    if(selectedSquare % width === width-1 && id === selectedSquare + 1) return;
    if(isBlocked(id)) return;

    squares[selectedSquare].classList.remove('selected');
    const from = selectedSquare;
    selectedSquare = null;

    doMove(from, id);
  } else {
    squares[selectedSquare].classList.remove('selected');
    selectedSquare = id;
    squares[id].classList.add('selected');
  }
}

function dragStart(){
  if(isResolving) return;
  const id = parseInt(this.id,10);
  if(isBlocked(id)) return;
  squareIdBeingDragged = this.id;
}

function dragDrop(){
  if(isResolving) return;
  const id = parseInt(this.id,10);
  if(isBlocked(id)) return;
  squareIdBeingReplaced = this.id;
}

function dragEnd(){
  if(isResolving) { squareIdBeingDragged=null; squareIdBeingReplaced=null; return; }
  if(squareIdBeingDragged === null || squareIdBeingReplaced === null) return;

  const from = parseInt(squareIdBeingDragged,10);
  const to   = parseInt(squareIdBeingReplaced,10);

  squareIdBeingDragged = null;
  squareIdBeingReplaced = null;

  if(isBlocked(from) || isBlocked(to)) return;

  const validMoves = [from-1, from+1, from-width, from+width];
  let validMove = validMoves.includes(to);

  if(from % width === 0 && to === from - 1) validMove = false;
  if(from % width === width-1 && to === from + 1) validMove = false;

  if(!validMove) return;

  doMove(from, to);
}

/* =========================================================================
   –•–û–î
============================================================================ */
function doSwap(a,b){
  const A = squares[a], B = squares[b];

  const tempColor = A.dataset.color;
  const tempType  = A.dataset.type;

  A.dataset.color = B.dataset.color;
  A.dataset.type  = B.dataset.type;
  B.dataset.color = tempColor;
  B.dataset.type  = tempType;

  A.style.backgroundImage = A.dataset.color ? `url('${resolveImage(A.dataset.color, A.dataset.type)}')` : '';
  B.style.backgroundImage = B.dataset.color ? `url('${resolveImage(B.dataset.color, B.dataset.type)}')` : '';
}

async function doMove(from,to){
  if(isResolving) return;
  isResolving = true;

  doSwap(from,to);
  tickObstaclesAfterMove();

  let activated = false;
  if(squares[to].dataset.type !== 'normal'){
    activated = await activateSpecialAt(to);
  } else if(squares[from].dataset.type !== 'normal'){
    activated = await activateSpecialAt(from);
  }

  if(activated){
    consumeMove();
    await resolveBoard();
    isResolving = false;
    checkLevelComplete();
    return;
  }

  const matches = findAllMatches();
  if(matches.length === 0){
    doSwap(from,to);
    isResolving = false;
    return;
  }

  consumeMove();
  await applyMatches(matches, {from, to});
  await resolveBoard();

  isResolving = false;
  checkLevelComplete();
}

/* =========================================================================
   –ê–ö–¢–ò–í–ê–¶–ò–Ø –°–ü–ï–¶-–≠–õ–ï–ú–ï–ù–¢–û–í
============================================================================ */
async function activateSpecialAt(i){
  const sq = squares[i];
  const type = sq.dataset.type;
  if(type === 'normal') return false;
  if(isBlocked(i)) return false;

  let affected = [];

  if(type === SPECIAL.LINE){
    const col = i % width;
    for(let r=0; r<width;r++) affected.push(r*width + col);

    addFxToCells([i], 'fx-line');
    addFxToCells(affected, 'fx-hit');
    flashGrid(false);

    await sleep(160);

    for(const idx of affected){
      if(squares[idx].dataset.block === BLOCK.ICE) damageIceAt(idx, 1);
      if(!isBlocked(idx)) clearCell(idx);
    }
    clearCell(i);
    addScore(8);
    return true;
  }

  if(type === SPECIAL.BOMB){
    const r0 = Math.floor(i/width);
    const c0 = i % width;
    for(let dr=-1; dr<=1; dr++){
      for(let dc=-1; dc<=1; dc++){
        const r = r0 + dr, c = c0 + dc;
        if(r<0||r>=width||c<0||c>=width) continue;
        affected.push(r*width + c);
      }
    }

    addFxToCells([i], 'fx-bomb');
    addFxToCells(affected, 'fx-hit');
    flashGrid(false);

    await sleep(170);

    for(const idx of affected){
      if(squares[idx].dataset.block === BLOCK.ICE) damageIceAt(idx, 1);
      if(!isBlocked(idx)) clearCell(idx);
    }
    clearCell(i);
    addScore(10);
    if(currentLevel().id === 3) BombActivated = true;
      return true;
  }

  if(type === SPECIAL.CLEAR){
    affected = Array.from({length: width*width}, (_,k)=>k);

    flashGrid(true);
    addFxToCells([i], 'fx-hit');

    for(let p=0; p<affected.length; p+=8){
      addFxToCells(affected.slice(p, p+8), 'fx-hit');
      await sleep(18);
    }

    for(let idx=0; idx<width*width; idx++){
      if(squares[idx].dataset.block === BLOCK.ICE) damageIceAt(idx, 1);
      if(!isBlocked(idx)) clearCell(idx);
    }
    addScore(16);
      if(currentLevel().id === 4) SnowflakeActivated = true;
     saveProgress();
    return true;
  }

  if(type === SPECIAL.CANDLE){
    const r0 = Math.floor(i/width);
    const c0 = i % width;
    for(let dr=-1; dr<=1; dr++){
      for(let dc=-1; dc<=1; dc++){
        const r = r0 + dr, c = c0 + dc;
        if(r<0||r>=width||c<0||c>=width) continue;
        affected.push(r*width + c);
      }
    }

    addFxToCells([i], 'fx-candle');
    addFxToCells(affected, 'fx-hit');
    flashGrid(false);

    await sleep(170);

    for(const idx of affected){
      if(squares[idx].dataset.block === BLOCK.ICE) damageIceAt(idx, 1);
      if(!isBlocked(idx)) clearCell(idx);
    }
    clearCell(i);
    addScore(12);
     saveProgress();
    return true;
  }

  return false;
}

/* =========================================================================
   –ü–û–ò–°–ö –ú–ê–¢–ß–ï–ô
============================================================================ */
function findAllMatches(){
  const groups = [];

  // —Å—Ç—Ä–æ–∫–∏
  for(let r=0;r<width;r++){
    let c=0;
    while(c<width){
      const idx = r*width + c;
      const key = squares[idx].dataset.color;
      const type = squares[idx].dataset.type;

      if(!key || type !== 'normal' || isBlocked(idx)){
        c++;
        continue;
      }

      let run = [idx];
      let cc = c+1;
      while(cc<width){
        const j = r*width + cc;
        if(squares[j].dataset.color === key && squares[j].dataset.type === 'normal' && !isBlocked(j)){
          run.push(j);
          cc++;
        } else break;
      }

      if(run.length >= 3){
        groups.push({cells:run, kind:'row', len:run.length, colorKey:key});
      }
      c = cc;
    }
  }

  // –∫–æ–ª–æ–Ω–∫–∏
  for(let c=0;c<width;c++){
    let r=0;
    while(r<width){
      const idx = r*width + c;
      const key = squares[idx].dataset.color;
      const type = squares[idx].dataset.type;

      if(!key || type !== 'normal' || isBlocked(idx)){
        r++;
        continue;
      }

      let run = [idx];
      let rr = r+1;
      while(rr<width){
        const j = rr*width + c;
        if(squares[j].dataset.color === key && squares[j].dataset.type === 'normal' && !isBlocked(j)){
          run.push(j);
          rr++;
        } else break;
      }

      if(run.length >= 3){
        groups.push({cells:run, kind:'col', len:run.length, colorKey:key});
      }
      r = rr;
    }
  }

  // L/T
  const cellToGroups = new Map();
  groups.forEach((g, gi)=>{
    g.cells.forEach(i=>{
      if(!cellToGroups.has(i)) cellToGroups.set(i, []);
      cellToGroups.get(i).push(gi);
    });
  });

  const ltGroups = [];
  cellToGroups.forEach((giList, cell)=>{
    if(giList.length >= 2){
      const keys = new Set(giList.map(gi=>groups[gi].colorKey));
      if(keys.size === 1){
        const union = new Set();
        giList.forEach(gi => groups[gi].cells.forEach(x=>union.add(x)));
        ltGroups.push({cells:[...union], kind:'lt', len:union.size, colorKey:[...keys][0], pivot:cell});
      }
    }
  });

  if(ltGroups.length){
    const blockedGroupIdx = new Set();
    ltGroups.forEach(lt=>{
      groups.forEach((g, gi)=>{
        if(g.colorKey !== lt.colorKey) return;
        const inter = g.cells.some(x=>lt.cells.includes(x));
        if(inter) blockedGroupIdx.add(gi);
      });
    });
    const filtered = groups.filter((g,gi)=>!blockedGroupIdx.has(gi));
    return [...filtered, ...ltGroups];
  }

  return groups;
}

/* =========================================================================
   –°–ü–ê–í–ù –°–ü–ï–¶–û–í –ò –û–ß–ò–°–¢–ö–ê
============================================================================ */
function levelHasSpecial(type){
  return currentLevel().specials.includes(type);
}

function addScore(n){
  score += n;
  setupHUD(); 
  saveProgress();
}

async function applyMatches(matches, moveInfo){
  const toClear = new Set();

  function chooseSpawnCell(group){
    const {from, to} = moveInfo || {};
    if(typeof to === 'number' && group.cells.includes(to)) return to;
    if(typeof from === 'number' && group.cells.includes(from)) return from;
    return group.cells[Math.floor(group.cells.length/2)];
  }

  const spawns = [];

  for(const g of matches){
    if(g.kind === 'lt'){
      if(levelHasSpecial(SPECIAL.BOMB)){
        spawns.push({ at: (g.pivot ?? chooseSpawnCell(g)), type: SPECIAL.BOMB });
      }
      g.cells.forEach(i=>toClear.add(i));
      continue;
    }

    if(g.len >= 5){
      if(levelHasSpecial(SPECIAL.CLEAR)){
        spawns.push({ at: chooseSpawnCell(g), type: SPECIAL.CLEAR });
      }
      g.cells.forEach(i=>toClear.add(i));
      continue;
    }

    if(g.len === 4){
      if(levelHasSpecial(SPECIAL.LINE)){
        const spawnAt = chooseSpawnCell(g);
        if(levelHasSpecial(SPECIAL.CANDLE) && g.colorKey === 'thermos'){
          spawns.push({ at: spawnAt, type: SPECIAL.CANDLE });
        } else {
          spawns.push({ at: spawnAt, type: SPECIAL.LINE });
        }
      }
      g.cells.forEach(i=>toClear.add(i));
      continue;
    }

    g.cells.forEach(i=>toClear.add(i));
  }

  const spawnCells = new Set(spawns.map(s=>s.at));
  const clearList = [...toClear].filter(i=>!spawnCells.has(i));

  clearList.forEach(i=>squares[i].classList.add('fade-out'));
  await sleep(220);

  for(const i of clearList){
    if(squares[i].dataset.block === BLOCK.ICE) damageIceAt(i, 1);
    if(!isBlocked(i)) clearCell(i);
    squares[i].classList.remove('fade-out');
  }

  for(const s of spawns){
    if(isBlocked(s.at)) continue;
    if(!squares[s.at].dataset.color) squares[s.at].dataset.color = randomNormal();
    squares[s.at].dataset.type = s.type;
    squares[s.at].style.backgroundImage = `url('${resolveImage(squares[s.at].dataset.color, squares[s.at].dataset.type)}')`;
  }

  addScore(clearList.length);
}

  function playIceSound(){
  try{
    SFX.ice.currentTime = 0;
    SFX.ice.play();
  }catch(e){
   
  }
}
/* =========================================================================
   –ì–†–ê–í–ò–¢–ê–¶–ò–Ø + –ö–ê–°–ö–ê–î–´
============================================================================ */
function moveDown(){
  for(let i = width*width - 1; i >= 0; i--){
    if(isBlocked(i)) continue;

    const below = i + width;
    if(below >= width*width) continue;
    if(isBlocked(below)) continue;

    if(!hasCandy(below) && hasCandy(i)){
      squares[below].dataset.color = squares[i].dataset.color;
      squares[below].dataset.type  = squares[i].dataset.type;
      squares[below].style.backgroundImage = squares[i].style.backgroundImage;
      clearCell(i);
    }
  }
}

function generateNewCandies(){
  for(let i=0;i<width;i++){
    if(isBlocked(i)) continue;
    if(!hasCandy(i)){
      setCell(squares[i], randomNormal(), 'normal');
    }
  }
}

async function resolveBoard(){
  for(let step=0; step<25; step++){
    for(let k=0;k<10;k++){
      moveDown();
      generateNewCandies();
      await sleep(40);
    }

    const matches = findAllMatches();
    if(matches.length === 0) break;

    await applyMatches(matches, null);
    await sleep(90);
  }
}

/* =========================================================================
   –°–¢–ê–†–¢ / –ü–ï–†–ï–•–û–î –£–†–û–í–ù–Ø
============================================================================ */
function stabilizeNoInitialMatches(){
  for(let tries=0; tries<30; tries++){
    const matches = findAllMatches();
    if(matches.length === 0) return;

    matches.forEach(g=>{
      const pick = g.cells[Math.floor(Math.random()*g.cells.length)];
      if(!isBlocked(pick)){
        setCell(squares[pick], randomNormal(), 'normal');
      }
    });
  }
}

function checkLevelComplete(){
  const lvl = currentLevel();
  const complete = 
  (lvl.id === 3) ? BombActivated : 
  (lvl.id === 4) ? SnowflakeActivated : (score >= lvl.target);
  if(complete){
    if(levelIndex < LEVELS.length-1){
      levelIndex++;
      startLevel(true);
       saveProgress();
    } else {
      introTitle.textContent = '–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ —É—Ä–æ–≤–Ω–∏! üéâ';
      introText.textContent  = '–ú–æ–∂–Ω–æ –∏–≥—Ä–∞—Ç—å –¥–∞–ª—å—à–µ —Ä–∞–¥–∏ –æ—á–∫–æ–≤ –∏–ª–∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.';
      introList.innerHTML = '';
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden','false');
    }
  }
}

function startLevel(resetScore){
  if(resetScore) score = 0;
  BombActivated = false;
  SnowflakeActivated = false;
  
  setupHUD();
  createBoard();
  showIntro();
}

function startGame(){
  levelIndex = 0;
  score = 0;

  energy = 1;
  movesLeft = MOVES_PER_LIFE;

  startLevel(true);
}

/* =========================================================================
   –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
============================================================================ */
setupHUD();
  if(loadProgress()){
    setupHUD();
    createBoard();
  } else { 
startGame();

  }
</script>
</body>
</html>
