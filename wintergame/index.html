<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–®–ê–ì–ê–ô –î–û–ú–ê: –ó–∏–º–Ω—è—è –∏–≥—Ä–∞</title>

  <style>
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;

      /* ‚úÖ –ù–û–í–û–ï: —Ñ–æ–Ω –∫–∞—Ä—Ç–∏–Ω–∫–æ–π IMG_3671.png (–ø–æ–≤–µ—Ä—Ö –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ª—ë–≥–∫–∏–π –≥—Ä–∞–¥–∏–µ–Ω—Ç) */
      background:
        linear-gradient(135deg, rgba(168,192,255,.75) 0%, rgba(63,43,150,.75) 100%),
        url("/wintergame/IMG_3671.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;

      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      min-height:100vh; margin:0; color:#fff;
      user-select:none;
    }

    h1{ text-shadow:2px 2px 4px rgba(0,0,0,.3); margin:0 0 10px; text-align:center; }

    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:center;
      flex-wrap:wrap;
      margin-bottom:14px;
    }

    .pill{
      background:rgba(255,255,255,.2);
      padding:10px 16px;
      border-radius:15px;
      font-size:18px;
      box-shadow:0 4px 6px rgba(0,0,0,.1);
      display:flex; gap:8px; align-items:center;
    }

    .grid{
      display:flex; flex-wrap:wrap;
      width:560px; height:560px;

      /* ‚úÖ –ù–û–í–û–ï: –ø–æ–¥–ª–æ–∂–∫–∞ IMG_3672.png */
      background-image:
        url("/wintergame/IMG_3672.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;

      border-radius:10px;
      padding:5px;
      box-shadow:0 10px 20px rgba(0,0,0,.2);
      position:relative;
    }

    .cell{
      width:70px; height:70px;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      transition:transform .18s, filter .18s, background-color .18s;
      border-radius:18px;

      background-repeat:no-repeat;
      background-position:center;
      background-size:contain;
      position:relative;
      overflow:hidden;
    }

    .cell:hover{
      transform:scale(1.06);
      background-color:rgba(255,255,255,.08);
    }

    .selected{
      background-color:rgba(255,255,255,.28) !important;
      transform:scale(1.10) !important;
      outline:2px solid rgba(255,255,255,.45);
      outline-offset:-2px;
    }

    .fade-out{ animation:fadeOut .45s forwards; }
    @keyframes fadeOut{ to{opacity:0; transform:scale(0)} }

    /* ---- –≤–∏–∑—É–∞–ª —Å–ø–µ—Ü–æ–≤ ---- */
    .cell[data-type="special_line"]{ filter:drop-shadow(0 0 10px rgba(255,215,0,.55)); }
    .cell[data-type="special_bomb"]{ filter:drop-shadow(0 0 10px rgba(255,255,255,.35)); }
    .cell[data-type="special_clear"]{ filter:drop-shadow(0 0 12px rgba(255,215,0,.75)); }
    .cell[data-type="special_candle"]{ filter:drop-shadow(0 0 12px rgba(255,140,0,.65)); }

    /* ---- –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è ---- */
    .cell[data-block="snow"]::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.7), rgba(255,255,255,0) 55%),
        radial-gradient(circle at 70% 40%, rgba(255,255,255,.6), rgba(255,255,255,0) 60%),
        linear-gradient(to bottom, rgba(255,255,255,.55), rgba(255,255,255,.15));
      opacity:.95;
      pointer-events:none;
    }
    .cell[data-block="snow"]::before{
      content:"‚õî";
      position:absolute; right:6px; top:6px;
      font-size:16px; opacity:.9;
      pointer-events:none;
    }

    .cell[data-block="ice"]::after{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(135deg, rgba(160,220,255,.55), rgba(70,160,255,.25)),
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,0) 55%);
      opacity:.95;
      pointer-events:none;
    }
    .cell[data-block="ice"]::before{
      content:attr(data-ice);
      position:absolute; right:8px; top:6px;
      font-weight:700;
      font-size:14px;
      background:rgba(0,0,0,.25);
      padding:2px 6px;
      border-radius:10px;
      pointer-events:none;
    }

    /* ---- –º–æ–¥–∞–ª–∫–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π —É—Ä–æ–≤–Ω—è ---- */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:50;
    }
    .overlay.show{ display:flex; }

    .modal{
      width:min(560px, 95vw);
      background:rgba(255,255,255,.96);
      color:#1f2937;
      border-radius:18px;
      padding:18px 18px 14px;
      box-shadow:0 16px 48px rgba(0,0,0,.35);
    }
    .modal h2{ margin:0 0 8px; font-size:20px; }
    .modal p{ margin:0 0 10px; line-height:1.45; }
    .modal ul{ margin:0 0 12px; padding-left:18px; }
    .modal li{ margin:6px 0; }
    .modal .actions{ display:flex; gap:10px; margin-top:10px; }
    .modal button{
      flex:1;
      margin:0;
      padding:10px 14px;
      font-size:16px;
      background:#ff6b6b;
      color:#fff;
      border:none;
      border-radius:14px;
      cursor:pointer;
      box-shadow:0 6px 18px rgba(0,0,0,.18);
      transition:background .2s, transform .15s;
    }
    .modal button:hover{ background:#ff4757; transform:translateY(-1px); }

    /* ---- –∫–Ω–æ–ø–∫–∏ —Å–Ω–∏–∑—É ---- */
    .btnbar{ display:flex; gap:12px; margin-top:18px; flex-wrap:wrap; justify-content:center; }
    .btnbar button{
      padding:10px 20px;
      font-size:18px;
      background:#ff6b6b;
      color:#fff;
      border:none;
      border-radius:50px;
      cursor:pointer;
      box-shadow:0 4px 15px rgba(0,0,0,.2);
      transition:background .3s, transform .15s;
    }
    .btnbar button:hover{ background:#ff4757; transform:translateY(-1px); }

    @media (max-width: 600px){
      .grid{ width:350px; height:350px; }
      .cell{ width:43.75px; height:43.75px; border-radius:14px; }
      h1{ font-size:24px; }
      .pill{ font-size:16px; }
    }
  </style>
</head>

<body>
  <h1>‚ùÑÔ∏è –®–ê–ì–ê–ô –î–û–ú–ê: –ó–∏–º–Ω—è—è –∏–≥—Ä–∞ ‚ùÑÔ∏è</h1>

  <div class="topbar">
    <div class="pill">–£—Ä–æ–≤–µ–Ω—å: <b id="level">1</b></div>
    <div class="pill">–û—á–∫–∏: <b id="score">0</b></div>
    <div class="pill">–¶–µ–ª—å: <b id="target">0</b></div>
  </div>

  <div class="grid" id="grid"></div>

  <div class="btnbar">
    <button onclick="startGame()">üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
    <button onclick="showIntro()">üìú –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —É—Ä–æ–≤–Ω—è</button>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal">
      <h2 id="introTitle">–£—Ä–æ–≤–µ–Ω—å</h2>
      <p id="introText"></p>
      <ul id="introList"></ul>
      <div class="actions">
        <button id="introBtn">–ü–æ–Ω—è—Ç–Ω–æ, –∏–≥—Ä–∞—é!</button>
      </div>
    </div>
  </div>

<script>
/* =========================================================================
   –ù–ê–°–¢–†–û–ô–ö–ê –ü–£–¢–ï–ô –ö –ö–ê–†–¢–ò–ù–ö–ê–ú
   -------------------------------------------------------------------------
   ‚úÖ –£ –¢–ï–ë–Ø –ö–ê–†–¢–ò–ù–ö–ò –í /wintergame/
   –ü–æ—ç—Ç–æ–º—É –∑–¥–µ—Å—å —Å—Ç–∞–≤–∏–º 'wintergame/' –∏ –¥–∞–ª—å—à–µ –í–°–ï –ø—É—Ç–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏.
============================================================================ */
const ASSET_PATH = '/wintergame/';

const IMG = {
  // –æ–±—ã—á–Ω—ã–µ
  snowflake: ASSET_PATH + 'IMG_3660.png',
  thermos:   ASSET_PATH + 'IMG_3661.png',
  steps:     ASSET_PATH + 'IMG_3662.png',
  boots:     ASSET_PATH + 'IMG_3663.png',
  mittens:   ASSET_PATH + 'IMG_3664.png',
  tree:      ASSET_PATH + 'IMG_3659.png',

  // —Å–ø–µ—Ü
  goldSteps:     ASSET_PATH + 'IMG_3655.png',
  candle:        ASSET_PATH + 'IMG_3656.png',
  giftBag:       ASSET_PATH + 'IMG_3657.png',
  goldSnowflake: ASSET_PATH + 'IMG_3658.png',

  // ‚úÖ –ù–û–í–û–ï (–Ω–∞ –±—É–¥—É—â–µ–µ, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –≤ JS)
  bg:    ASSET_PATH + 'IMG_3671.png',
  board: ASSET_PATH + 'IMG_3672.png',
};

const NORMAL_COLORS = ['snowflake','thermos','steps','boots','mittens','tree'];

// —Ç–∏–ø—ã —Å–ø–µ—Ü–æ–≤
const SPECIAL = {
  LINE:  'special_line',
  BOMB:  'special_bomb',
  CLEAR: 'special_clear',
  CANDLE:'special_candle',
};

// –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
const BLOCK = {
  SNOW: 'snow',
  ICE:  'ice',
};

// —É—Ä–æ–≤–Ω–∏ –ø–æ —Ç–≤–æ–µ–º—É –¢–ó
const LEVELS = [
  { id:1,  target: 60,  intro:"–£—Ä–æ–≤–µ–Ω—å 1 ‚Äî –±–µ–∑ —Å–ø–µ—Ü-—ç–ª–µ–º–µ–Ω—Ç–æ–≤. –ü—Ä–æ—Å—Ç–æ —Å–æ–±–∏—Ä–∞–π—Ç–µ 3 –≤ —Ä—è–¥.", specials:[], obstacles:[] },
  { id:2,  target: 80,  intro:"–£—Ä–æ–≤–µ–Ω—å 2 ‚Äî –ø–æ—è–≤–ª—è—é—Ç—Å—è ¬´–ó–æ–ª–æ—Ç—ã–µ —à–∞–≥–∏¬ª. –°–æ–±–µ—Ä–∏—Ç–µ 4 –≤ —Ä—è–¥ ‚Üí –ø–æ—è–≤–∏—Ç—Å—è —Å–ø–µ—Ü. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –µ–≥–æ —Å–ª–µ–¥—É—é—â–∏–º —Ö–æ–¥–æ–º (–ø–µ—Ä–µ–¥–≤–∏–Ω—å—Ç–µ) ‚Üí –æ—á–∏—Å—Ç–∏—Ç—Å—è —Å—Ç—Ä–æ–∫–∞.", specials:[SPECIAL.LINE], obstacles:[] },
  { id:3,  target: 95,  intro:"–£—Ä–æ–≤–µ–Ω—å 3 ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –º–µ—à–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤. –°–æ–±–µ—Ä–∏—Ç–µ L/T-–∫–æ–º–±–∏–Ω–∞—Ü–∏—é ‚Üí –ø–æ—è–≤–∏—Ç—Å—è –º–µ—à–æ–∫, –æ–Ω –≤–∑—Ä—ã–≤–∞–µ—Ç –æ–±–ª–∞—Å—Ç—å 3√ó3.", specials:[SPECIAL.LINE, SPECIAL.BOMB], obstacles:[] },
  { id:4,  target: 115, intro:"–£—Ä–æ–≤–µ–Ω—å 4 ‚Äî –∑–æ–ª–æ—Ç–∞—è —Å–Ω–µ–∂–∏–Ω–∫–∞. –°–æ–±–µ—Ä–∏—Ç–µ 5 –≤ —Ä—è–¥ ‚Üí –ø–æ—è–≤–∏—Ç—Å—è —Å–Ω–µ–∂–∏–Ω–∫–∞, –æ–Ω–∞ –æ—á–∏—â–∞–µ—Ç –≤–µ—Å—å —ç–∫—Ä–∞–Ω.", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[] },
  { id:5,  target: 135, intro:"–£—Ä–æ–≤–µ–Ω—å 5 ‚Äî –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ ¬´–°–Ω–µ–∂–Ω—ã–π —Å—É–≥—Ä–æ–±¬ª. –û–Ω –±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–ª–µ—Ç–∫—É –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ö–æ–¥–æ–≤.", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[BLOCK.SNOW] },

  { id:6,  target: 155, intro:"–£—Ä–æ–≤–µ–Ω—å 6 ‚Äî –±–æ–ª—å—à–µ —Å—É–≥—Ä–æ–±–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ø–µ—Ü-—ç–ª–µ–º–µ–Ω—Ç—ã, —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–∂–¥–∞—Ç—å –ø–æ–ª–µ.", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[BLOCK.SNOW] },
  { id:7,  target: 175, intro:"–£—Ä–æ–≤–µ–Ω—å 7 ‚Äî —Å—É–≥—Ä–æ–±—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —á–∞—â–µ. –î–µ–ª–∞–π—Ç–µ 4 –∏ 5 –≤ —Ä—è–¥ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—á–∏—Å—Ç–æ–∫.", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[BLOCK.SNOW] },
  { id:8,  target: 195, intro:"–£—Ä–æ–≤–µ–Ω—å 8 ‚Äî –¥–µ—Ä–∂–∏–º —Ç–µ–º–ø: –∫–∞—Å–∫–∞–¥—ã –ø–æ—Å–ª–µ –ø–∞–¥–µ–Ω–∏—è —Ñ–∏—à–µ–∫ –¥–∞—é—Ç –±–æ–ª—å—à–µ –º–∞—Ç—á–µ–π.", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[BLOCK.SNOW] },
  { id:9,  target: 215, intro:"–£—Ä–æ–≤–µ–Ω—å 9 ‚Äî –ø–æ—á—Ç–∏ —Ñ–∏–Ω–∞–ª –ø–µ—Ä–µ–¥ –ª—å–¥–æ–º. –ì–æ—Ç–æ–≤–∏–º—Å—è –∫ –∑–∞–º–æ—Ä–æ–∑–∫–µ!", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR], obstacles:[BLOCK.SNOW] },

  { id:10, target: 240, intro:"–£—Ä–æ–≤–µ–Ω—å 10 ‚Äî –ø–æ—è–≤–ª—è–µ—Ç—Å—è ¬´–õ–µ–¥—è–Ω–∞—è –∫–ª–µ—Ç–∫–∞¬ª (3 —Å–ª–æ—è) –∏ ¬´–°–≤–µ—á–∫–∞¬ª. –°–≤–µ—á–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å–Ω–∏–º–∞–µ—Ç 1 —Å–ª–æ–π –ª—å–¥–∞ –≤ –æ–±–ª–∞—Å—Ç–∏ 3√ó3.", specials:[SPECIAL.LINE, SPECIAL.BOMB, SPECIAL.CLEAR, SPECIAL.CANDLE], obstacles:[BLOCK.SNOW, BLOCK.ICE] },
];

const width = 8;
const grid = document.getElementById('grid');
const scoreDisplay = document.getElementById('score');
const levelDisplay = document.getElementById('level');
const targetDisplay = document.getElementById('target');

const overlay = document.getElementById('overlay');
const introTitle = document.getElementById('introTitle');
const introText  = document.getElementById('introText');
const introList  = document.getElementById('introList');
const introBtn   = document.getElementById('introBtn');

let squares = [];
let score = 0;
let levelIndex = 0;

let selectedSquare = null;

let squareIdBeingDragged = null;
let squareIdBeingReplaced = null;

let isResolving = false;

/* =========================================================================
   –ú–û–î–ï–õ–¨ –ö–õ–ï–¢–ö–ò (dataset):
============================================================================ */
function setCell(square, colorKey, type='normal'){
  square.dataset.color = colorKey || '';
  square.dataset.type = type || 'normal';
  const img = resolveImage(square.dataset.color, square.dataset.type);
  square.style.backgroundImage = img ? `url('${img}')` : '';
}

function resolveImage(colorKey, type){
  if(!colorKey) return '';
  if(type === SPECIAL.LINE)   return IMG.goldSteps;
  if(type === SPECIAL.BOMB)   return IMG.giftBag;
  if(type === SPECIAL.CLEAR)  return IMG.goldSnowflake;
  if(type === SPECIAL.CANDLE) return IMG.candle;
  return IMG[colorKey] || '';
}

function isBlocked(i){
  const sq = squares[i];
  return (sq.dataset.block === BLOCK.SNOW && (+sq.dataset.turns || 0) > 0)
      || (sq.dataset.block === BLOCK.ICE  && (+sq.dataset.icehp || 0) > 0);
}

function clearCell(i){
  const sq = squares[i];
  setCell(sq, '', 'normal');
}

function hasCandy(i){
  return squares[i].dataset.color !== '';
}

function randomNormal(){
  return NORMAL_COLORS[Math.floor(Math.random() * NORMAL_COLORS.length)];
}

/* =========================================================================
   –£–†–û–í–ù–ò: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª—è + –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
============================================================================ */
function currentLevel(){
  return LEVELS[levelIndex] || LEVELS[LEVELS.length-1];
}

function showIntro(){
  const lvl = currentLevel();
  introTitle.textContent = `–£—Ä–æ–≤–µ–Ω—å ${lvl.id}`;
  introText.textContent = lvl.intro;

  introList.innerHTML = '';
  const items = [];
  items.push('–°–æ–±–µ—Ä–∏—Ç–µ 3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Ñ–∏—à–∫–∏ –ø–æ–¥—Ä—è–¥ ‚Äî –æ–Ω–∏ –∏—Å—á–µ–∑–Ω—É—Ç, –∞ –Ω–æ–≤—ã–µ —É–ø–∞–¥—É—Ç —Å–≤–µ—Ä—Ö—É.');

  const s = lvl.specials;
  if(s.includes(SPECIAL.LINE))  items.push('4 –≤ —Ä—è–¥ ‚Üí ¬´–ó–æ–ª–æ—Ç—ã–µ —à–∞–≥–∏¬ª. –ü–µ—Ä–µ–¥–≤–∏–Ω—å—Ç–µ –∏—Ö —Å–ª–µ–¥—É—é—â–∏–º —Ö–æ–¥–æ–º ‚Üí –æ—á–∏—Å—Ç–∏—Ç—Å—è —Å—Ç—Ä–æ–∫–∞.');
  if(s.includes(SPECIAL.BOMB))  items.push('L/T-–∫–æ–º–±–∏–Ω–∞—Ü–∏—è ‚Üí ¬´–ú–µ—à–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤¬ª (–≤–∑—Ä—ã–≤ 3√ó3).');
  if(s.includes(SPECIAL.CLEAR)) items.push('5 –≤ —Ä—è–¥ ‚Üí ¬´–ó–æ–ª–æ—Ç–∞—è —Å–Ω–µ–∂–∏–Ω–∫–∞¬ª (–æ—á–∏—â–∞–µ—Ç –≤–µ—Å—å —ç–∫—Ä–∞–Ω).');
  if(lvl.obstacles.includes(BLOCK.SNOW)) items.push('–°—É–≥—Ä–æ–±—ã –±–ª–æ–∫–∏—Ä—É—é—Ç –∫–ª–µ—Ç–∫–∏ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ö–æ–¥–æ–≤ (–∏—Ö –Ω–µ–ª—å–∑—è –¥–≤–∏–≥–∞—Ç—å).');
  if(lvl.obstacles.includes(BLOCK.ICE))  items.push('–õ—ë–¥ (3 —Å–ª–æ—è) –ª–æ–º–∞–µ—Ç—Å—è –ø–æ 1 —Å–ª–æ—é –æ—Ç —ç—Ñ—Ñ–µ–∫—Ç–æ–≤. –°–≤–µ—á–∫–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞–∑–º–æ—Ä–∞–∂–∏–≤–∞—Ç—å –ª—ë–¥.');

  items.forEach(t=>{
    const li = document.createElement('li');
    li.textContent = t;
    introList.appendChild(li);
  });

  overlay.classList.add('show');
  overlay.setAttribute('aria-hidden','false');
}

introBtn.onclick = () => {
  overlay.classList.remove('show');
  overlay.setAttribute('aria-hidden','true');
};

overlay.addEventListener('click', (e)=>{
  if(e.target === overlay){
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden','true');
  }
});

function setupHUD(){
  const lvl = currentLevel();
  levelDisplay.textContent = lvl.id;
  targetDisplay.textContent = lvl.target;
  scoreDisplay.textContent = score;
}

function placeObstacles(){
  const lvl = currentLevel();

  for(let i=0;i<squares.length;i++){
    squares[i].dataset.block = '';
    squares[i].dataset.turns = '';
    squares[i].dataset.icehp = '';
    squares[i].dataset.ice = '';
  }

  if(lvl.obstacles.includes(BLOCK.SNOW)){
    const count = Math.min(10, 3 + Math.floor((lvl.id-5)*1.2));
    dropSnow(count);
  }

  if(lvl.obstacles.includes(BLOCK.ICE)){
    const count = 10;
    dropIce(count);
  }
}

function dropSnow(count){
  let placed = 0;
  let tries = 0;
  while(placed < count && tries < 500){
    tries++;
    const i = Math.floor(Math.random() * (width*width));
    if(i < width) continue;
    if(squares[i].dataset.block) continue;

    squares[i].dataset.block = BLOCK.SNOW;
    squares[i].dataset.turns = 3;
    placed++;
  }
}

function dropIce(count){
  let placed = 0;
  let tries = 0;
  while(placed < count && tries < 800){
    tries++;
    const i = Math.floor(Math.random() * (width*width));
    if(squares[i].dataset.block) continue;
    if(i < width) continue;

    squares[i].dataset.block = BLOCK.ICE;
    squares[i].dataset.icehp = 3;
    squares[i].dataset.ice = '3';
    placed++;
  }
}

function tickObstaclesAfterMove(){
  for(let i=0;i<squares.length;i++){
    if(squares[i].dataset.block === BLOCK.SNOW){
      let t = (+squares[i].dataset.turns || 0);
      if(t > 0){
        t--;
        squares[i].dataset.turns = String(t);
        if(t <= 0){
          squares[i].dataset.block = '';
          squares[i].dataset.turns = '';
        }
      }
    }
  }
}

function damageIceAt(i, amount=1){
  const sq = squares[i];
  if(sq.dataset.block !== BLOCK.ICE) return;

  let hp = (+sq.dataset.icehp || 0);
  if(hp <= 0) return;

  hp = Math.max(0, hp - amount);
  sq.dataset.icehp = String(hp);
  sq.dataset.ice = hp ? String(hp) : '';

  if(hp === 0){
    sq.dataset.block = '';
    sq.dataset.icehp = '';
    sq.dataset.ice = '';
  }
}

/* =========================================================================
   –°–û–ó–î–ê–ù–ò–ï –ü–û–õ–Ø
============================================================================ */
function createBoard(){
  grid.innerHTML = '';
  squares = [];

  for(let i=0;i<width*width;i++){
    const sq = document.createElement('div');
    sq.className = 'cell';
    sq.setAttribute('draggable', true);
    sq.setAttribute('id', i);

    setCell(sq, randomNormal(), 'normal');

    sq.addEventListener('click', selectSquare);

    sq.addEventListener('dragstart', dragStart);
    sq.addEventListener('dragover', (e)=>e.preventDefault());
    sq.addEventListener('dragenter', (e)=>e.preventDefault());
    sq.addEventListener('drop', dragDrop);
    sq.addEventListener('dragend', dragEnd);

    grid.appendChild(sq);
    squares.push(sq);
  }

  placeObstacles();
  stabilizeNoInitialMatches();
}

/* =========================================================================
   –í–´–ë–û–† / –ü–ï–†–ï–°–¢–ê–ù–û–í–ö–ê
============================================================================ */
function selectSquare(e){
  if(isResolving) return;

  const id = parseInt(e.currentTarget.id, 10);
  if(isBlocked(id)) return;

  if(selectedSquare === null){
    selectedSquare = id;
    squares[id].classList.add('selected');
    return;
  }

  if(selectedSquare === id){
    squares[selectedSquare].classList.remove('selected');
    selectedSquare = null;
    return;
  }

  const validMoves = [selectedSquare-1, selectedSquare+1, selectedSquare-width, selectedSquare+width];
  const isAdjacent = validMoves.includes(id);

  if(isAdjacent){
    if(selectedSquare % width === 0 && id === selectedSquare - 1) return;
    if(selectedSquare % width === width-1 && id === selectedSquare + 1) return;
    if(isBlocked(id)) return;

    doMove(selectedSquare, id);
    squares[selectedSquare].classList.remove('selected');
    selectedSquare = null;
  } else {
    squares[selectedSquare].classList.remove('selected');
    selectedSquare = id;
    squares[id].classList.add('selected');
  }
}

function dragStart(e){
  if(isResolving) return;
  const id = parseInt(this.id,10);
  if(isBlocked(id)) return;
  squareIdBeingDragged = this.id;
}

function dragDrop(e){
  if(isResolving) return;
  const id = parseInt(this.id,10);
  if(isBlocked(id)) return;
  squareIdBeingReplaced = this.id;
}

function dragEnd(){
  if(isResolving) { squareIdBeingDragged=null; squareIdBeingReplaced=null; return; }
  if(squareIdBeingDragged === null || squareIdBeingReplaced === null) return;

  const from = parseInt(squareIdBeingDragged,10);
  const to   = parseInt(squareIdBeingReplaced,10);

  squareIdBeingDragged = null;
  squareIdBeingReplaced = null;

  if(isBlocked(from) || isBlocked(to)) return;

  const validMoves = [from-1, from+1, from-width, from+width];
  let validMove = validMoves.includes(to);

  if(from % width === 0 && to === from - 1) validMove = false;
  if(from % width === width-1 && to === from + 1) validMove = false;

  if(!validMove) return;

  doMove(from, to);
}

/* =========================================================================
   –•–û–î: swap ‚Üí (–µ—Å–ª–∏ —Å–ø–µ—Ü –ø–µ—Ä–µ–¥–≤–∏–Ω—É—Ç ‚Äî –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å) ‚Üí –∏–Ω–∞—á–µ –∏—Å–∫–∞—Ç—å –º–∞—Ç—á–∏
============================================================================ */
function doSwap(a,b){
  const A = squares[a], B = squares[b];

  const tempColor = A.dataset.color;
  const tempType  = A.dataset.type;

  A.dataset.color = B.dataset.color;
  A.dataset.type  = B.dataset.type;
  B.dataset.color = tempColor;
  B.dataset.type  = tempType;

  A.style.backgroundImage = A.dataset.color ? `url('${resolveImage(A.dataset.color, A.dataset.type)}')` : '';
  B.style.backgroundImage = B.dataset.color ? `url('${resolveImage(B.dataset.color, B.dataset.type)}')` : '';
}

function doMove(from,to){
  if(isResolving) return;
  isResolving = true;

  doSwap(from,to);
  tickObstaclesAfterMove();

  let activated = false;
  if(squares[to].dataset.type !== 'normal'){
    activated = activateSpecialAt(to);
  } else if(squares[from].dataset.type !== 'normal'){
    activated = activateSpecialAt(from);
  }

  if(activated){
    resolveBoard().then(()=>{
      isResolving = false;
      checkLevelComplete();
    });
    return;
  }

  const matches = findAllMatches();
  if(matches.length === 0){
    doSwap(from,to);
    isResolving = false;
    return;
  }

  applyMatches(matches, {from, to}).then(()=>{
    resolveBoard().then(()=>{
      isResolving = false;
      checkLevelComplete();
    });
  });
}

/* =========================================================================
   –ê–ö–¢–ò–í–ê–¶–ò–Ø –°–ü–ï–¶-–≠–õ–ï–ú–ï–ù–¢–û–í
============================================================================ */
function activateSpecialAt(i){
  const sq = squares[i];
  const type = sq.dataset.type;
  if(type === 'normal') return false;
  if(isBlocked(i)) return false;

  if(type === SPECIAL.LINE){
    const row = Math.floor(i / width);
    const start = row * width;
    for(let c=0;c<width;c++){
      const idx = start + c;
      if(squares[idx].dataset.block === BLOCK.ICE) damageIceAt(idx, 1);
      if(!isBlocked(idx)) clearCell(idx);
    }
    clearCell(i);
    addScore(8);
    return true;
  }

  if(type === SPECIAL.BOMB){
    const r0 = Math.floor(i/width);
    const c0 = i % width;
    for(let dr=-1; dr<=1; dr++){
      for(let dc=-1; dc<=1; dc++){
        const r = r0 + dr, c = c0 + dc;
        if(r<0||r>=width||c<0||c>=width) continue;
        const idx = r*width + c;
        if(squares[idx].dataset.block === BLOCK.ICE) damageIceAt(idx, 1);
        if(!isBlocked(idx)) clearCell(idx);
      }
    }
    clearCell(i);
    addScore(10);
    return true;
  }

  if(type === SPECIAL.CLEAR){
    for(let idx=0; idx<width*width; idx++){
      if(squares[idx].dataset.block === BLOCK.ICE) damageIceAt(idx, 1);
      if(!isBlocked(idx)) clearCell(idx);
    }
    addScore(16);
    return true;
  }

  if(type === SPECIAL.CANDLE){
    const r0 = Math.floor(i/width);
    const c0 = i % width;
    for(let dr=-1; dr<=1; dr++){
      for(let dc=-1; dc<=1; dc++){
        const r = r0 + dr, c = c0 + dc;
        if(r<0||r>=width||c<0||c>=width) continue;
        const idx = r*width + c;

        if(squares[idx].dataset.block === BLOCK.ICE) damageIceAt(idx, 1);
        if(!isBlocked(idx)) clearCell(idx);
      }
    }
    clearCell(i);
    addScore(12);
    return true;
  }

  return false;
}

/* =========================================================================
   –ü–û–ò–°–ö –ú–ê–¢–ß–ï–ô
============================================================================ */
function findAllMatches(){
  const groups = [];

  for(let r=0;r<width;r++){
    let c=0;
    while(c<width){
      const idx = r*width + c;
      const key = squares[idx].dataset.color;
      const type = squares[idx].dataset.type;

      if(!key || type !== 'normal' || isBlocked(idx)){
        c++;
        continue;
      }

      let run = [idx];
      let cc = c+1;
      while(cc<width){
        const j = r*width + cc;
        if(squares[j].dataset.color === key && squares[j].dataset.type === 'normal' && !isBlocked(j)){
          run.push(j);
          cc++;
        } else break;
      }

      if(run.length >= 3){
        groups.push({cells:run, kind:'row', len:run.length, colorKey:key});
      }
      c = cc;
    }
  }

  for(let c=0;c<width;c++){
    let r=0;
    while(r<width){
      const idx = r*width + c;
      const key = squares[idx].dataset.color;
      const type = squares[idx].dataset.type;

      if(!key || type !== 'normal' || isBlocked(idx)){
        r++;
        continue;
      }

      let run = [idx];
      let rr = r+1;
      while(rr<width){
        const j = rr*width + c;
        if(squares[j].dataset.color === key && squares[j].dataset.type === 'normal' && !isBlocked(j)){
          run.push(j);
          rr++;
        } else break;
      }

      if(run.length >= 3){
        groups.push({cells:run, kind:'col', len:run.length, colorKey:key});
      }
      r = rr;
    }
  }

  const cellToGroups = new Map();
  groups.forEach((g, gi)=>{
    g.cells.forEach(i=>{
      if(!cellToGroups.has(i)) cellToGroups.set(i, []);
      cellToGroups.get(i).push(gi);
    });
  });

  const ltGroups = [];
  cellToGroups.forEach((giList, cell)=>{
    if(giList.length >= 2){
      const keys = new Set(giList.map(gi=>groups[gi].colorKey));
      if(keys.size === 1){
        const union = new Set();
        giList.forEach(gi => groups[gi].cells.forEach(x=>union.add(x)));
        ltGroups.push({cells:[...union], kind:'lt', len:union.size, colorKey:[...keys][0], pivot:cell});
      }
    }
  });

  if(ltGroups.length){
    const blockedGroupIdx = new Set();
    ltGroups.forEach(lt=>{
      groups.forEach((g, gi)=>{
        if(g.colorKey !== lt.colorKey) return;
        const inter = g.cells.some(x=>lt.cells.includes(x));
        if(inter) blockedGroupIdx.add(gi);
      });
    });
    const filtered = groups.filter((g,gi)=>!blockedGroupIdx.has(gi));
    return [...filtered, ...ltGroups];
  }

  return groups;
}

/* =========================================================================
   –°–ü–ê–í–ù –°–ü–ï–¶–û–í –ò –û–ß–ò–°–¢–ö–ê
============================================================================ */
function levelHasSpecial(type){
  return currentLevel().specials.includes(type);
}

function addScore(n){
  score += n;
  scoreDisplay.textContent = score;
}

async function applyMatches(matches, moveInfo){
  const toClear = new Set();

  function chooseSpawnCell(group){
    const {from, to} = moveInfo || {};
    if(typeof to === 'number' && group.cells.includes(to)) return to;
    if(typeof from === 'number' && group.cells.includes(from)) return from;
    return group.cells[Math.floor(group.cells.length/2)];
  }

  const spawns = [];
  for(const g of matches){
    if(g.kind === 'lt'){
      if(levelHasSpecial(SPECIAL.BOMB)){
        spawns.push({ at: g.pivot ?? chooseSpawnCell(g), type: SPECIAL.BOMB });
      }
      g.cells.forEach(i=>toClear.add(i));
      continue;
    }

    if(g.len >= 5){
      if(levelHasSpecial(SPECIAL.CLEAR)){
        spawns.push({ at: chooseSpawnCell(g), type: SPECIAL.CLEAR });
      }
      g.cells.forEach(i=>toClear.add(i));
      continue;
    }

    if(g.len === 4){
      if(levelHasSpecial(SPECIAL.LINE)){
        const spawnAt = chooseSpawnCell(g);
        if(levelHasSpecial(SPECIAL.CANDLE) && g.colorKey === 'thermos'){
          spawns.push({ at: spawnAt, type: SPECIAL.CANDLE });
        } else {
          spawns.push({ at: spawnAt, type: SPECIAL.LINE });
        }
      }
      g.cells.forEach(i=>toClear.add(i));
      continue;
    }

    g.cells.forEach(i=>toClear.add(i));
  }

  const spawnCells = new Set(spawns.map(s=>s.at));

  const clearList = [...toClear].filter(i=>!spawnCells.has(i));
  clearList.forEach(i=>squares[i].classList.add('fade-out'));

  await sleep(220);

  for(const i of clearList){
    if(squares[i].dataset.block === BLOCK.ICE) damageIceAt(i, 1);
    if(!isBlocked(i)) clearCell(i);
    squares[i].classList.remove('fade-out');
  }

  for(const s of spawns){
    if(isBlocked(s.at)) continue;
    if(!squares[s.at].dataset.color) squares[s.at].dataset.color = randomNormal();
    squares[s.at].dataset.type = s.type;
    squares[s.at].style.backgroundImage = `url('${resolveImage(squares[s.at].dataset.color, squares[s.at].dataset.type)}')`;
  }

  addScore(clearList.length);
}

function sleep(ms){ return new Promise(res=>setTimeout(res, ms)); }

/* =========================================================================
   –ì–†–ê–í–ò–¢–ê–¶–ò–Ø + –ö–ê–°–ö–ê–î–´
============================================================================ */
function moveDown(){
  for(let i = width*width - 1; i >= 0; i--){
    if(isBlocked(i)) continue;

    const below = i + width;
    if(below >= width*width) continue;
    if(isBlocked(below)) continue;

    if(!hasCandy(below) && hasCandy(i)){
      squares[below].dataset.color = squares[i].dataset.color;
      squares[below].dataset.type  = squares[i].dataset.type;
      squares[below].style.backgroundImage = squares[i].style.backgroundImage;
      clearCell(i);
    }
  }
}

function generateNewCandies(){
  for(let i=0;i<width;i++){
    if(isBlocked(i)) continue;
    if(!hasCandy(i)){
      setCell(squares[i], randomNormal(), 'normal');
    }
  }
}

async function resolveBoard(){
  for(let step=0; step<25; step++){
    for(let k=0;k<10;k++){
      moveDown();
      generateNewCandies();
      await sleep(40);
    }

    const matches = findAllMatches();
    if(matches.length === 0) break;

    await applyMatches(matches, null);
    await sleep(90);
  }
}

/* =========================================================================
   –°–¢–ê–†–¢ / –ü–ï–†–ï–•–û–î –£–†–û–í–ù–Ø
============================================================================ */
function stabilizeNoInitialMatches(){
  for(let tries=0; tries<30; tries++){
    const matches = findAllMatches();
    if(matches.length === 0) return;

    matches.forEach(g=>{
      const pick = g.cells[Math.floor(Math.random()*g.cells.length)];
      if(!isBlocked(pick)){
        setCell(squares[pick], randomNormal(), 'normal');
      }
    });
  }
}

function checkLevelComplete(){
  const lvl = currentLevel();
  if(score >= lvl.target){
    if(levelIndex < LEVELS.length-1){
      levelIndex++;
      startLevel(false);
    } else {
      introTitle.textContent = '–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ —É—Ä–æ–≤–Ω–∏! üéâ';
      introText.textContent  = '–ú–æ–∂–Ω–æ –∏–≥—Ä–∞—Ç—å –¥–∞–ª—å—à–µ —Ä–∞–¥–∏ –æ—á–∫–æ–≤ –∏–ª–∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.';
      introList.innerHTML = '';
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden','false');
    }
  }
}

function startLevel(resetScore){
  if(resetScore){
    score = 0;
  }
  setupHUD();
  createBoard();
  showIntro();
}

function startGame(){
  levelIndex = 0;
  score = 0;
  startLevel(true);
}

/* =========================================================================
   –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
============================================================================ */
setupHUD();
startGame();
</script>
</body>
</html>
